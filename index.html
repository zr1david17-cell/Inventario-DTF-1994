<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor DTF - Control de Impresiones</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .badge-printed {
            background: #10b981;
            color: white;
            font-weight: 600;
        }
        .badge-not-printed {
            background: #ef4444;
            color: white;
            font-weight: 600;
        }
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: pointer;
        }
        .modal-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
        }
        .image-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .image-thumbnail:hover {
            transform: scale(1.1);
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Componente principal
        function GestorDTF() {
            const [designs, setDesigns] = useState([]);
            const [activeTab, setActiveTab] = useState('pedido'); // pedido, inventario, nuevo
            const [searchTerm, setSearchTerm] = useState('');
            
            // Estados para nuevo dise√±o
            const [newDesign, setNewDesign] = useState({
                code: '',
                client: '',
                description: '',
                notes: '',
                isPrinted: false,
                image: null,
                stock: 0
            });

            // Estado para ver imagen en grande
            const [viewImage, setViewImage] = useState(null);
            
            // Estado para gesti√≥n de cantidades en pedidos
            const [orderQuantities, setOrderQuantities] = useState({});

            // Estados para procesador de pedidos
            const [orderCodes, setOrderCodes] = useState('');
            const [orderResults, setOrderResults] = useState(null);
            const [isProcessingOCR, setIsProcessingOCR] = useState(false);
            const [ocrPreview, setOcrPreview] = useState(null);

            // Cargar datos del almacenamiento persistente
            useEffect(() => {
                loadDesigns();
            }, []);

            const loadDesigns = () => {
                try {
                    const stored = localStorage.getItem('dtf_designs');
                    if (stored) {
                        setDesigns(JSON.parse(stored));
                    } else {
                        setDesigns([]);
                    }
                } catch (error) {
                    console.log('Iniciando con inventario vac√≠o');
                    setDesigns([]);
                }
            };

            const saveDesign = (design) => {
                try {
                    const currentDesigns = JSON.parse(localStorage.getItem('dtf_designs') || '[]');
                    const existingIndex = currentDesigns.findIndex(d => d.code === design.code);
                    
                    if (existingIndex >= 0) {
                        currentDesigns[existingIndex] = design;
                    } else {
                        currentDesigns.push(design);
                    }
                    
                    const dataToSave = JSON.stringify(currentDesigns);
                    
                    // Check size before saving
                    const sizeInMB = new Blob([dataToSave]).size / (1024 * 1024);
                    if (sizeInMB > 9) {
                        alert('‚ö†Ô∏è Advertencia: El almacenamiento est√° casi lleno.\n\nTienes demasiadas im√°genes guardadas.\nConsidera reducir la calidad de las im√°genes.');
                    }
                    
                    localStorage.setItem('dtf_designs', dataToSave);
                    loadDesigns();
                    return true;
                } catch (error) {
                    console.error('Error guardando dise√±o:', error);
                    if (error.name === 'QuotaExceededError') {
                        alert('‚ùå Error: Almacenamiento lleno!\n\nNo se puede guardar m√°s im√°genes.\nExporta tus datos y reduce el tama√±o de las im√°genes.');
                    } else {
                        alert('‚ùå Error al guardar: ' + error.message);
                    }
                    return false;
                }
            };

            const deleteDesign = (code) => {
                try {
                    const currentDesigns = JSON.parse(localStorage.getItem('dtf_designs') || '[]');
                    const filtered = currentDesigns.filter(d => d.code !== code);
                    localStorage.setItem('dtf_designs', JSON.stringify(filtered));
                    loadDesigns();
                    return true;
                } catch (error) {
                    console.error('Error eliminando dise√±o:', error);
                    return false;
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('La imagen es muy grande. M√°ximo 5MB');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setNewDesign({...newDesign, image: event.target.result});
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleOCRImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 10 * 1024 * 1024) {
                    alert('La imagen es muy grande. M√°ximo 10MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (event) => {
                    setOcrPreview(event.target.result);
                    setIsProcessingOCR(true);
                    
                    try {
                        const result = await Tesseract.recognize(
                            event.target.result,
                            'eng+spa',
                            {
                                logger: (m) => {
                                    if (m.status === 'recognizing text') {
                                        console.log(`Escaneando: ${Math.round(m.progress * 100)}%`);
                                    }
                                }
                            }
                        );

                        const extractedText = result.data.text;
                        
                        // Agregar texto extra√≠do al campo de c√≥digos
                        setOrderCodes(prev => {
                            const combined = prev ? prev + '\n' + extractedText : extractedText;
                            return combined;
                        });
                        
                        alert('‚úÖ C√≥digos extra√≠dos de la imagen. Revisa y procesa el pedido.');
                    } catch (error) {
                        console.error('Error OCR:', error);
                        alert('Error al escanear la imagen. Intenta con otra imagen m√°s clara.');
                    } finally {
                        setIsProcessingOCR(false);
                    }
                };
                reader.readAsDataURL(file);
            };

            const handleAddDesign = async () => {
                if (!newDesign.code.trim()) {
                    alert('¬°El c√≥digo es obligatorio!');
                    return;
                }

                const designToSave = {
                    ...newDesign,
                    code: newDesign.code.trim().toUpperCase(),
                    stock: parseInt(newDesign.stock) || 0,
                    createdAt: new Date().toISOString(),
                    lastPrinted: newDesign.isPrinted ? new Date().toISOString() : null
                };

                const success = await saveDesign(designToSave);
                if (success) {
                    setNewDesign({
                        code: '',
                        client: '',
                        description: '',
                        notes: '',
                        isPrinted: false,
                        image: null,
                        stock: 0
                    });
                    alert('‚úÖ Dise√±o agregado exitosamente');
                    setActiveTab('inventario');
                }
            };

            const handleProcessOrder = () => {
                if (!orderCodes.trim()) {
                    alert('¬°Ingresa los c√≥digos del pedido!');
                    return;
                }

                const codes = orderCodes
                    .split(/[\n,;]+/)
                    .map(c => c.trim().toUpperCase())
                    .filter(c => c.length > 0);

                const results = {
                    total: codes.length,
                    printed: [],
                    notPrinted: [],
                    notFound: []
                };

                // Inicializar cantidades para el pedido
                const quantities = {};
                codes.forEach(code => {
                    quantities[code] = (quantities[code] || 0) + 1;
                });
                setOrderQuantities(quantities);

                codes.forEach(code => {
                    const design = designs.find(d => d.code === code);
                    if (!design) {
                        results.notFound.push(code);
                    } else if (design.isPrinted && design.stock > 0) {
                        results.printed.push(design);
                    } else {
                        results.notPrinted.push(design);
                    }
                });

                setOrderResults(results);
            };

            const updateStock = (code, newStock) => {
                const design = designs.find(d => d.code === code);
                if (design) {
                    const updatedDesign = {
                        ...design,
                        stock: Math.max(0, parseInt(newStock) || 0)
                    };
                    saveDesign(updatedDesign);
                }
            };

            const addStock = (code, quantity) => {
                const design = designs.find(d => d.code === code);
                if (design) {
                    const updatedDesign = {
                        ...design,
                        stock: (design.stock || 0) + parseInt(quantity),
                        isPrinted: true,
                        lastPrinted: new Date().toISOString()
                    };
                    saveDesign(updatedDesign);
                    alert(`‚úÖ Se agregaron ${quantity} unidades al stock de ${code}`);
                }
            };

            const deliverOrder = (code, quantity) => {
                const design = designs.find(d => d.code === code);
                if (!design) return;

                const qtyToDeliver = parseInt(quantity) || 1;
                
                if (design.stock < qtyToDeliver) {
                    alert(`‚ö†Ô∏è Solo tienes ${design.stock} unidades de ${code}. Necesitas ${qtyToDeliver}.`);
                    return;
                }

                const updatedDesign = {
                    ...design,
                    stock: design.stock - qtyToDeliver
                };
                saveDesign(updatedDesign);
                
                // Actualizar resultados del pedido
                if (orderResults) {
                    handleProcessOrder();
                }
            };

            const markAsPrinted = (code) => {
                const design = designs.find(d => d.code === code);
                if (design) {
                    const updatedDesign = {
                        ...design,
                        isPrinted: true,
                        lastPrinted: new Date().toISOString()
                    };
                    saveDesign(updatedDesign);
                    
                    // Actualizar resultados del pedido
                    if (orderResults) {
                        handleProcessOrder();
                    }
                }
            };

            const togglePrintStatus = (code) => {
                const design = designs.find(d => d.code === code);
                if (design) {
                    const updatedDesign = {
                        ...design,
                        isPrinted: !design.isPrinted,
                        lastPrinted: !design.isPrinted ? new Date().toISOString() : design.lastPrinted
                    };
                    saveDesign(updatedDesign);
                }
            };

            const filteredDesigns = designs.filter(d => 
                d.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
                d.client.toLowerCase().includes(searchTerm.toLowerCase()) ||
                d.description.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const stats = {
                total: designs.length,
                printed: designs.filter(d => d.isPrinted).length,
                notPrinted: designs.filter(d => !d.isPrinted).length,
                totalStock: designs.reduce((sum, d) => sum + (d.stock || 0), 0),
                lowStock: designs.filter(d => d.stock > 0 && d.stock <= 3).length,
                outOfStock: designs.filter(d => d.isPrinted && d.stock === 0).length
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="glass p-6 mb-6">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                                        üé® Gestor DTF Pro
                                    </h1>
                                    <p className="text-gray-600">Control total de tu inventario de impresiones</p>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => {
                                            try {
                                                const data = {
                                                    designs: designs,
                                                    exportDate: new Date().toISOString(),
                                                    version: '1.0'
                                                };
                                                const dataStr = JSON.stringify(data, null, 2);
                                                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                                                const url = URL.createObjectURL(dataBlob);
                                                const link = document.createElement('a');
                                                link.href = url;
                                                link.download = `gestor-dtf-backup-${new Date().toISOString().split('T')[0]}.json`;
                                                link.click();
                                                URL.revokeObjectURL(url);
                                                alert('‚úÖ Respaldo exportado exitosamente!\n\nGuarda este archivo en un lugar seguro.');
                                            } catch (error) {
                                                console.error('Error exportando:', error);
                                                alert('‚ùå Error al exportar datos');
                                            }
                                        }}
                                        className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold text-sm"
                                    >
                                        üíæ Exportar Datos
                                    </button>
                                    <button
                                        onClick={() => {
                                            const input = document.createElement('input');
                                            input.type = 'file';
                                            input.accept = '.json';
                                            input.onchange = (e) => {
                                                const file = e.target.files[0];
                                                if (!file) return;
                                                
                                                const reader = new FileReader();
                                                reader.onload = (event) => {
                                                    try {
                                                        const data = JSON.parse(event.target.result);
                                                        
                                                        if (!data.designs || !Array.isArray(data.designs)) {
                                                            alert('‚ùå Archivo inv√°lido. No contiene datos de dise√±os.');
                                                            return;
                                                        }
                                                        
                                                        const confirmed = confirm(
                                                            `¬øImportar ${data.designs.length} dise√±os?\n\n` +
                                                            `Esto reemplazar√° todos tus datos actuales.\n` +
                                                            `Fecha del respaldo: ${data.exportDate ? new Date(data.exportDate).toLocaleString('es-MX') : 'Desconocida'}\n\n` +
                                                            `¬øContinuar?`
                                                        );
                                                        
                                                        if (!confirmed) return;
                                                        
                                                        localStorage.setItem('dtf_designs', JSON.stringify(data.designs));
                                                        loadDesigns();
                                                        alert(`‚úÖ ¬°Importaci√≥n exitosa!\n\n${data.designs.length} dise√±os importados correctamente.`);
                                                    } catch (error) {
                                                        console.error('Error importando:', error);
                                                        alert('‚ùå Error al importar datos. Verifica que el archivo sea v√°lido.');
                                                    }
                                                };
                                                reader.readAsText(file);
                                            };
                                            input.click();
                                        }}
                                        className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-semibold text-sm"
                                    >
                                        üìÇ Importar Datos
                                    </button>
                                    <button
                                        onClick={() => {
                                            const confirmed = confirm(
                                                'üîÑ REINICIAR SISTEMA\n\n' +
                                                'Esto har√° lo siguiente:\n' +
                                                '1. Exportar√° autom√°ticamente tus datos actuales\n' +
                                                '2. Limpiar√° el almacenamiento\n' +
                                                '3. Te permitir√° importar de nuevo\n\n' +
                                                '√ötil cuando el almacenamiento est√° lleno.\n\n' +
                                                '¬øContinuar?'
                                            );
                                            
                                            if (!confirmed) return;
                                            
                                            try {
                                                // Auto-export first
                                                const data = {
                                                    designs: designs,
                                                    exportDate: new Date().toISOString(),
                                                    version: '1.0'
                                                };
                                                const dataStr = JSON.stringify(data, null, 2);
                                                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                                                const url = URL.createObjectURL(dataBlob);
                                                const link = document.createElement('a');
                                                link.href = url;
                                                link.download = `RESPALDO-ANTES-REINICIO-${new Date().toISOString().split('T')[0]}.json`;
                                                link.click();
                                                URL.revokeObjectURL(url);
                                                
                                                setTimeout(() => {
                                                    const confirmed2 = confirm(
                                                        '‚úÖ Respaldo guardado!\n\n' +
                                                        'Ahora se limpiar√° el almacenamiento.\n\n' +
                                                        'Despu√©s podr√°s importar tus datos de nuevo.\n' +
                                                        'Las im√°genes se guardar√°n comprimidas.\n\n' +
                                                        '¬øContinuar con la limpieza?'
                                                    );
                                                    
                                                    if (confirmed2) {
                                                        localStorage.clear();
                                                        alert('‚úÖ Sistema reiniciado!\n\nAhora usa "üìÇ Importar Datos" para cargar tu respaldo.\n\nLas nuevas im√°genes se guardar√°n comprimidas.');
                                                        loadDesigns();
                                                    }
                                                }, 1000);
                                            } catch (error) {
                                                console.error('Error:', error);
                                                alert('‚ùå Error durante el reinicio');
                                            }
                                        }}
                                        className="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 font-semibold text-sm"
                                    >
                                        üîÑ Reiniciar Sistema
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                            <div className="glass p-4">
                                <div className="text-2xl font-bold text-purple-600">{stats.total}</div>
                                <div className="text-sm text-gray-600">Total Dise√±os</div>
                            </div>
                            <div className="glass p-4">
                                <div className="text-2xl font-bold text-green-600">{stats.printed}</div>
                                <div className="text-sm text-gray-600">Ya Impresos</div>
                            </div>
                            <div className="glass p-4">
                                <div className="text-2xl font-bold text-red-600">{stats.notPrinted}</div>
                                <div className="text-sm text-gray-600">Sin Imprimir</div>
                            </div>
                            <div className="glass p-4">
                                <div className="text-2xl font-bold text-blue-600">{stats.totalStock}</div>
                                <div className="text-sm text-gray-600">Stock Total</div>
                            </div>
                            <div className="glass p-4">
                                <div className="text-2xl font-bold text-orange-600">{stats.lowStock}</div>
                                <div className="text-sm text-gray-600">Stock Bajo (‚â§3)</div>
                            </div>
                            <div className="glass p-4">
                                <div className="text-2xl font-bold text-red-700">{stats.outOfStock}</div>
                                <div className="text-sm text-gray-600">Agotados</div>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="glass p-2 mb-6">
                            <div className="flex gap-2 flex-wrap">
                                <button
                                    onClick={() => setActiveTab('pedido')}
                                    className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${
                                        activeTab === 'pedido'
                                            ? 'btn-primary text-white'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    üì¶ Procesar Pedido
                                </button>
                                <button
                                    onClick={() => setActiveTab('inventario')}
                                    className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${
                                        activeTab === 'inventario'
                                            ? 'btn-primary text-white'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    üìö Inventario
                                </button>
                                <button
                                    onClick={() => setActiveTab('importar')}
                                    className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${
                                        activeTab === 'importar'
                                            ? 'btn-primary text-white'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    üì• Importar Masivo
                                </button>
                                <button
                                    onClick={() => setActiveTab('nuevo')}
                                    className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${
                                        activeTab === 'nuevo'
                                            ? 'btn-primary text-white'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    ‚ûï Nuevo Dise√±o
                                </button>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="glass p-6">
                            {activeTab === 'pedido' && (
                                <div className="animate-slide-in">
                                    <h2 className="text-2xl font-bold mb-4 text-gray-800">üì¶ Procesar Pedido</h2>
                                    
                                    {/* Opci√≥n 1: Escanear imagen */}
                                    <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                                        <h3 className="font-bold text-lg mb-2 text-blue-900">üì∏ Opci√≥n 1: Escanear Imagen (OCR)</h3>
                                        <p className="text-sm text-gray-700 mb-3">
                                            Sube una foto o captura del pedido y la app extraer√° los c√≥digos autom√°ticamente
                                        </p>
                                        <div className="flex gap-3 items-center">
                                            <label className="btn-primary text-white py-3 px-6 rounded-lg font-semibold cursor-pointer hover:shadow-lg transition-all">
                                                {isProcessingOCR ? '‚è≥ Escaneando...' : 'üì∑ Subir Foto del Pedido'}
                                                <input
                                                    type="file"
                                                    accept="image/*"
                                                    capture="environment"
                                                    onChange={handleOCRImageUpload}
                                                    disabled={isProcessingOCR}
                                                    className="hidden"
                                                />
                                            </label>
                                            {ocrPreview && (
                                                <img 
                                                    src={ocrPreview} 
                                                    alt="Preview" 
                                                    className="h-16 w-16 object-cover rounded-lg cursor-pointer border-2 border-blue-300"
                                                    onClick={() => setViewImage(ocrPreview)}
                                                />
                                            )}
                                        </div>
                                        {isProcessingOCR && (
                                            <div className="mt-3 text-sm text-blue-700 font-semibold animate-pulse">
                                                üîç Escaneando c√≥digos en la imagen...
                                            </div>
                                        )}
                                    </div>

                                    {/* Opci√≥n 2: Copiar y pegar */}
                                    <div className="bg-gradient-to-r from-green-50 to-teal-50 border-2 border-green-200 rounded-lg p-4 mb-4">
                                        <h3 className="font-bold text-lg mb-2 text-green-900">‚úçÔ∏è Opci√≥n 2: Copiar y Pegar</h3>
                                        <p className="text-sm text-gray-700 mb-3">
                                            Pega los c√≥digos del pedido (uno por l√≠nea o separados por comas)
                                        </p>
                                        <textarea
                                            value={orderCodes}
                                            onChange={(e) => setOrderCodes(e.target.value)}
                                            placeholder="Ejemplo:&#10;DTF001&#10;DTF002&#10;A-123, B-456"
                                            className="w-full p-4 border-2 border-gray-300 rounded-lg font-mono"
                                            rows="6"
                                        />
                                    </div>

                                    <button
                                        onClick={handleProcessOrder}
                                        disabled={!orderCodes.trim()}
                                        className="w-full btn-primary text-white py-4 px-6 rounded-lg font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        üîç Verificar Pedido
                                    </button>

                                    {orderResults && (
                                        <div className="mt-6 space-y-4">
                                            <div className="bg-blue-50 border-l-4 border-blue-500 p-4">
                                                <h3 className="font-bold text-blue-900">
                                                    üìä Resumen: {orderResults.total} c√≥digos verificados
                                                </h3>
                                            </div>

                                            {orderResults.notPrinted.length > 0 && (
                                                <div className="bg-red-50 border-l-4 border-red-500 p-4">
                                                    <h3 className="font-bold text-red-900 mb-3 text-xl">
                                                        üö® SIN STOCK - NECESITAS IMPRIMIR ({orderResults.notPrinted.length})
                                                    </h3>
                                                    <div className="space-y-2">
                                                        {orderResults.notPrinted.map(design => {
                                                            const quantityNeeded = orderQuantities[design.code] || 1;
                                                            return (
                                                                <div key={design.code} className="bg-white p-3 rounded-lg flex gap-4 items-center">
                                                                    {design.image && (
                                                                        <img 
                                                                            src={design.image} 
                                                                            alt={design.code}
                                                                            className="image-thumbnail"
                                                                            onClick={() => setViewImage(design.image)}
                                                                            title="Click para ver en grande"
                                                                        />
                                                                    )}
                                                                    <div className="flex-1">
                                                                        <div className="font-bold text-lg">{design.code}</div>
                                                                        <div className="text-sm text-gray-600">
                                                                            {design.client && `Cliente: ${design.client}`}
                                                                            {design.description && ` - ${design.description}`}
                                                                        </div>
                                                                        <div className="text-sm text-red-700 font-semibold mt-1">
                                                                            Stock actual: {design.stock || 0} - Necesitas: {quantityNeeded}
                                                                        </div>
                                                                        {design.notes && (
                                                                            <div className="text-xs text-gray-500 mt-1">
                                                                                {design.notes}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    <button
                                                                        onClick={() => {
                                                                            const qty = prompt(`¬øCu√°ntas unidades de ${design.code} vas a imprimir?`, quantityNeeded);
                                                                            if (qty && parseInt(qty) > 0) {
                                                                                addStock(design.code, parseInt(qty));
                                                                            }
                                                                        }}
                                                                        className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-semibold whitespace-nowrap"
                                                                    >
                                                                        üñ®Ô∏è Ya Imprim√≠
                                                                    </button>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )}

                                            {orderResults.printed.length > 0 && (
                                                <div className="bg-green-50 border-l-4 border-green-500 p-4">
                                                    <h3 className="font-bold text-green-900 mb-3">
                                                        ‚úÖ DISPONIBLES EN STOCK ({orderResults.printed.length})
                                                    </h3>
                                                    <div className="space-y-2">
                                                        {orderResults.printed.map(design => {
                                                            const quantityNeeded = orderQuantities[design.code] || 1;
                                                            const hasEnough = design.stock >= quantityNeeded;
                                                            return (
                                                                <div key={design.code} className="bg-white p-3 rounded-lg">
                                                                    <div className="flex gap-4 items-center">
                                                                        {design.image && (
                                                                            <img 
                                                                                src={design.image} 
                                                                                alt={design.code}
                                                                                className="image-thumbnail"
                                                                                onClick={() => setViewImage(design.image)}
                                                                                title="Click para ver en grande"
                                                                            />
                                                                        )}
                                                                        <div className="flex-1">
                                                                            <div className="font-bold text-lg">{design.code}</div>
                                                                            <div className="text-sm text-gray-600">
                                                                                {design.client && `Cliente: ${design.client}`}
                                                                            </div>
                                                                            <div className={`text-sm font-semibold mt-1 ${hasEnough ? 'text-green-700' : 'text-red-700'}`}>
                                                                                Stock: {design.stock} unidades {!hasEnough && `(‚ö†Ô∏è Faltan ${quantityNeeded - design.stock})`}
                                                                            </div>
                                                                            <div className="text-sm text-gray-700 mt-1">
                                                                                Cantidad pedida: {quantityNeeded} unidad{quantityNeeded > 1 ? 'es' : ''}
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex flex-col gap-2">
                                                                            {hasEnough ? (
                                                                                <button
                                                                                    onClick={() => deliverOrder(design.code, quantityNeeded)}
                                                                                    className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold whitespace-nowrap"
                                                                                >
                                                                                    üì¶ Entregar ({quantityNeeded})
                                                                                </button>
                                                                            ) : (
                                                                                <button
                                                                                    disabled
                                                                                    className="bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-semibold whitespace-nowrap cursor-not-allowed"
                                                                                >
                                                                                    ‚ö†Ô∏è Stock Insuficiente
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )}

                                            {orderResults.notFound.length > 0 && (
                                                <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                                                    <h3 className="font-bold text-yellow-900 mb-3">
                                                        ‚ö†Ô∏è NO ENCONTRADOS ({orderResults.notFound.length})
                                                    </h3>
                                                    <div className="text-sm text-yellow-800">
                                                        {orderResults.notFound.join(', ')}
                                                    </div>
                                                    <div className="text-sm text-yellow-700 mt-2">
                                                        Estos c√≥digos no est√°n en tu inventario. Agr√©galos primero.
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'inventario' && (
                                <div className="animate-slide-in">
                                    <div className="mb-6">
                                        <h2 className="text-2xl font-bold mb-4 text-gray-800">üìö Inventario Completo</h2>
                                        <input
                                            type="text"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            placeholder="üîç Buscar por c√≥digo, cliente o descripci√≥n..."
                                            className="w-full p-4 border-2 border-gray-300 rounded-lg"
                                        />
                                    </div>

                                    <div className="space-y-3 max-h-[600px] overflow-y-auto">
                                        {filteredDesigns.length === 0 ? (
                                            <div className="text-center py-12 text-gray-500">
                                                {designs.length === 0 
                                                    ? '¬°A√∫n no tienes dise√±os! Agrega tu primer dise√±o en la pesta√±a "Nuevo Dise√±o"'
                                                    : 'No se encontraron dise√±os con ese criterio de b√∫squeda'
                                                }
                                            </div>
                                        ) : (
                                            filteredDesigns.map(design => {
                                                const stockStatus = design.stock === 0 ? 'bg-red-100 border-red-300' : 
                                                                   design.stock <= 3 ? 'bg-yellow-100 border-yellow-300' : 
                                                                   'bg-white border-gray-200';
                                                return (
                                                    <div key={design.code} className={`border-2 rounded-lg p-4 hover:shadow-lg transition-shadow ${stockStatus}`}>
                                                        <div className="flex gap-4">
                                                            {design.image && (
                                                                <div className="flex-shrink-0">
                                                                    <img 
                                                                        src={design.image} 
                                                                        alt={design.code}
                                                                        className="image-thumbnail"
                                                                        onClick={() => setViewImage(design.image)}
                                                                        title="Click para ver en grande"
                                                                    />
                                                                </div>
                                                            )}
                                                            <div className="flex-1">
                                                                <div className="flex items-center gap-3 mb-2 flex-wrap">
                                                                    <span className="text-xl font-bold text-purple-600">{design.code}</span>
                                                                    <span className={`px-3 py-1 rounded-full text-xs ${design.isPrinted ? 'badge-printed' : 'badge-not-printed'}`}>
                                                                        {design.isPrinted ? '‚úì IMPRESO' : '‚è≥ PENDIENTE'}
                                                                    </span>
                                                                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                                        design.stock === 0 ? 'bg-red-500 text-white' :
                                                                        design.stock <= 3 ? 'bg-orange-500 text-white' :
                                                                        'bg-blue-500 text-white'
                                                                    }`}>
                                                                        üì¶ Stock: {design.stock || 0}
                                                                    </span>
                                                                </div>
                                                                {design.client && (
                                                                    <div className="text-sm text-gray-700 mb-1">
                                                                        <span className="font-semibold">Cliente:</span> {design.client}
                                                                    </div>
                                                                )}
                                                                {design.description && (
                                                                    <div className="text-sm text-gray-700 mb-1">
                                                                        <span className="font-semibold">Descripci√≥n:</span> {design.description}
                                                                    </div>
                                                                )}
                                                                {design.notes && (
                                                                    <div className="text-sm text-gray-600 mb-1">
                                                                        <span className="font-semibold">Notas:</span> {design.notes}
                                                                    </div>
                                                                )}
                                                                {design.lastPrinted && (
                                                                    <div className="text-xs text-gray-500 mt-2">
                                                                        √öltima impresi√≥n: {new Date(design.lastPrinted).toLocaleString('es-MX')}
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Stock management */}
                                                                <div className="mt-3 flex gap-2 flex-wrap">
                                                                    <button
                                                                        onClick={() => {
                                                                            const input = document.createElement('input');
                                                                            input.type = 'file';
                                                                            input.accept = 'image/*';
                                                                            input.onchange = (e) => {
                                                                                const file = e.target.files[0];
                                                                                if (file) {
                                                                                    if (file.size > 5 * 1024 * 1024) {
                                                                                        alert('La imagen es muy grande. M√°ximo 5MB');
                                                                                        return;
                                                                                    }
                                                                                    
                                                                                    const reader = new FileReader();
                                                                                    reader.onload = (event) => {
                                                                                        // Compress image before saving
                                                                                        const img = new Image();
                                                                                        img.onload = () => {
                                                                                            const canvas = document.createElement('canvas');
                                                                                            let width = img.width;
                                                                                            let height = img.height;
                                                                                            
                                                                                            // Resize if too large
                                                                                            const maxSize = 800;
                                                                                            if (width > maxSize || height > maxSize) {
                                                                                                if (width > height) {
                                                                                                    height = (height / width) * maxSize;
                                                                                                    width = maxSize;
                                                                                                } else {
                                                                                                    width = (width / height) * maxSize;
                                                                                                    height = maxSize;
                                                                                                }
                                                                                            }
                                                                                            
                                                                                            canvas.width = width;
                                                                                            canvas.height = height;
                                                                                            const ctx = canvas.getContext('2d');
                                                                                            ctx.drawImage(img, 0, 0, width, height);
                                                                                            
                                                                                            // Convert to compressed base64
                                                                                            const compressedImage = canvas.toDataURL('image/jpeg', 0.7);
                                                                                            
                                                                                            const updatedDesign = {
                                                                                                ...design,
                                                                                                image: compressedImage
                                                                                            };
                                                                                            
                                                                                            const success = saveDesign(updatedDesign);
                                                                                            if (success) {
                                                                                                alert(`‚úÖ Imagen agregada a ${design.code}`);
                                                                                            }
                                                                                        };
                                                                                        img.src = event.target.result;
                                                                                    };
                                                                                    reader.readAsDataURL(file);
                                                                                }
                                                                            };
                                                                            input.click();
                                                                        }}
                                                                        className="bg-purple-500 text-white px-3 py-1 rounded-lg hover:bg-purple-600 text-sm font-semibold"
                                                                    >
                                                                        {design.image ? 'üñºÔ∏è Cambiar Imagen' : 'üì∑ Agregar Imagen'}
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const qty = prompt(`Agregar stock a ${design.code}. ¬øCu√°ntas unidades?`, '10');
                                                                            if (qty && parseInt(qty) > 0) {
                                                                                addStock(design.code, parseInt(qty));
                                                                            }
                                                                        }}
                                                                        className="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 text-sm font-semibold"
                                                                    >
                                                                        ‚ûï Agregar Stock
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const qty = prompt(`Quitar stock de ${design.code}. Stock actual: ${design.stock}. ¬øCu√°ntas unidades quitar?`, '1');
                                                                            if (qty && parseInt(qty) > 0) {
                                                                                updateStock(design.code, design.stock - parseInt(qty));
                                                                            }
                                                                        }}
                                                                        className="bg-orange-500 text-white px-3 py-1 rounded-lg hover:bg-orange-600 text-sm font-semibold"
                                                                    >
                                                                        ‚ûñ Quitar Stock
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const qty = prompt(`Ajustar stock de ${design.code}. Stock actual: ${design.stock}. Nuevo stock:`, design.stock);
                                                                            if (qty !== null) {
                                                                                updateStock(design.code, parseInt(qty) || 0);
                                                                            }
                                                                        }}
                                                                        className="bg-gray-500 text-white px-3 py-1 rounded-lg hover:bg-gray-600 text-sm font-semibold"
                                                                    >
                                                                        ‚úèÔ∏è Ajustar
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2 items-start">
                                                                <button
                                                                    onClick={() => togglePrintStatus(design.code)}
                                                                    className={`px-4 py-2 rounded-lg font-semibold text-sm ${
                                                                        design.isPrinted
                                                                            ? 'bg-yellow-500 text-white hover:bg-yellow-600'
                                                                            : 'bg-green-500 text-white hover:bg-green-600'
                                                                    }`}
                                                                >
                                                                    {design.isPrinted ? '‚Ü©Ô∏è Desmarcar' : '‚úì Marcar'}
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        if (confirm(`¬øEliminar ${design.code}?`)) {
                                                                            deleteDesign(design.code);
                                                                        }
                                                                    }}
                                                                    className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold text-sm"
                                                                >
                                                                    üóëÔ∏è
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'importar' && (
                                <div className="animate-slide-in">
                                    <h2 className="text-2xl font-bold mb-4 text-gray-800">üì• Importaci√≥n Masiva de Dise√±os</h2>
                                    
                                    <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                                        <h3 className="font-bold text-blue-900 mb-2">¬øC√≥mo funciona?</h3>
                                        <p className="text-sm text-blue-800 mb-2">
                                            Pega una lista de c√≥digos (uno por l√≠nea) y el sistema los agregar√° todos autom√°ticamente.
                                        </p>
                                        <p className="text-xs text-blue-700">
                                            Ejemplo: RT01, DM06, PT02, etc. Todos quedar√°n como "Por imprimir" con stock 0.
                                        </p>
                                    </div>

                                    <textarea
                                        id="bulkImportCodes"
                                        placeholder={"RT01\nRT02\nDM06\nTYT01\nPT01\nPT02\n...\n\n(Pega todos tus c√≥digos aqu√≠)"}
                                        className="w-full p-4 border-2 border-gray-300 rounded-lg font-mono mb-4"
                                        rows="15"
                                    />

                                    <button
                                        onClick={() => {
                                            const textarea = document.getElementById('bulkImportCodes');
                                            const text = textarea.value.trim();
                                            
                                            if (!text) {
                                                alert('¬°Pega los c√≥digos en el cuadro de texto!');
                                                return;
                                            }

                                            const codes = text
                                                .split(/[\n,;]+/)
                                                .map(c => c.trim().toUpperCase())
                                                .filter(c => c.length > 0);

                                            if (codes.length === 0) {
                                                alert('No se encontraron c√≥digos v√°lidos');
                                                return;
                                            }

                                            const confirmed = confirm(`¬øImportar ${codes.length} dise√±os?\n\nTodos quedar√°n como "Por imprimir" con stock 0.\nPodr√°s agregar im√°genes y detalles despu√©s.`);
                                            
                                            if (!confirmed) return;

                                            try {
                                                const currentDesigns = JSON.parse(localStorage.getItem('dtf_designs') || '[]');
                                                let imported = 0;
                                                let skipped = 0;

                                                codes.forEach(code => {
                                                    const exists = currentDesigns.find(d => d.code === code);
                                                    if (exists) {
                                                        skipped++;
                                                        return;
                                                    }

                                                    const newDesign = {
                                                        code: code,
                                                        client: '',
                                                        description: '',
                                                        notes: '',
                                                        isPrinted: false,
                                                        image: null,
                                                        stock: 0,
                                                        createdAt: new Date().toISOString(),
                                                        lastPrinted: null
                                                    };

                                                    currentDesigns.push(newDesign);
                                                    imported++;
                                                });

                                                localStorage.setItem('dtf_designs', JSON.stringify(currentDesigns));
                                                loadDesigns();

                                                alert(`‚úÖ Importaci√≥n completa!\n\n‚úì Importados: ${imported}\n‚äò Ya exist√≠an: ${skipped}\n\nAhora puedes agregar im√°genes y detalles desde el Inventario.`);
                                                textarea.value = '';
                                                setActiveTab('inventario');
                                            } catch (error) {
                                                console.error('Error en importaci√≥n:', error);
                                                alert('‚ùå Error en la importaci√≥n. Por favor intenta de nuevo.');
                                            }
                                        }}
                                        className="w-full btn-primary text-white py-4 px-6 rounded-lg font-semibold text-lg"
                                    >
                                        ‚ö° Importar Todos los C√≥digos
                                    </button>

                                    <div className="mt-6 bg-gray-50 p-4 rounded-lg">
                                        <h3 className="font-bold text-gray-800 mb-2">üí° Consejo Pro:</h3>
                                        <p className="text-sm text-gray-700 mb-2">
                                            Despu√©s de importar, ve al Inventario y:
                                        </p>
                                        <ul className="text-sm text-gray-600 space-y-1 ml-4">
                                            <li>‚Ä¢ Busca cada dise√±o por c√≥digo</li>
                                            <li>‚Ä¢ Agrega su imagen (captura de pantalla de tu archivo)</li>
                                            <li>‚Ä¢ Agrega cliente y descripci√≥n si quieres</li>
                                            <li>‚Ä¢ Ajusta el stock de los que ya tienes impresos</li>
                                        </ul>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'nuevo' && (
                                <div className="animate-slide-in">
                                    <h2 className="text-2xl font-bold mb-6 text-gray-800">‚ûï Agregar Nuevo Dise√±o</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                C√≥digo del Dise√±o *
                                            </label>
                                            <input
                                                type="text"
                                                value={newDesign.code}
                                                onChange={(e) => setNewDesign({...newDesign, code: e.target.value})}
                                                placeholder="Ej: DTF001, A-123, LOGO-CLIENTE"
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg font-mono text-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                üì∏ Imagen del Dise√±o
                                            </label>
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onChange={handleImageUpload}
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                            />
                                            {newDesign.image && (
                                                <div className="mt-3 flex items-center gap-3">
                                                    <img 
                                                        src={newDesign.image} 
                                                        alt="Preview" 
                                                        className="image-preview cursor-pointer"
                                                        onClick={() => setViewImage(newDesign.image)}
                                                    />
                                                    <button
                                                        onClick={() => setNewDesign({...newDesign, image: null})}
                                                        className="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm"
                                                    >
                                                        üóëÔ∏è Quitar imagen
                                                    </button>
                                                </div>
                                            )}
                                            <p className="text-xs text-gray-500 mt-1">
                                                Sube una captura o foto de tu dise√±o (m√°x. 5MB)
                                            </p>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Cliente
                                            </label>
                                            <input
                                                type="text"
                                                value={newDesign.client}
                                                onChange={(e) => setNewDesign({...newDesign, client: e.target.value})}
                                                placeholder="Nombre del cliente"
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Descripci√≥n
                                            </label>
                                            <input
                                                type="text"
                                                value={newDesign.description}
                                                onChange={(e) => setNewDesign({...newDesign, description: e.target.value})}
                                                placeholder="Ej: Logo empresa, Dise√±o camiseta deportiva"
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Notas
                                            </label>
                                            <textarea
                                                value={newDesign.notes}
                                                onChange={(e) => setNewDesign({...newDesign, notes: e.target.value})}
                                                placeholder="Notas adicionales, colores especiales, instrucciones..."
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                                rows="3"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                üì¶ Stock Inicial (Cantidad de unidades)
                                            </label>
                                            <input
                                                type="number"
                                                min="0"
                                                value={newDesign.stock}
                                                onChange={(e) => setNewDesign({...newDesign, stock: e.target.value})}
                                                placeholder="0"
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">
                                                ¬øCu√°ntas unidades tienes impresas f√≠sicamente?
                                            </p>
                                        </div>
                                        <div className="flex items-center gap-3 bg-gray-50 p-4 rounded-lg">
                                            <input
                                                type="checkbox"
                                                id="isPrinted"
                                                checked={newDesign.isPrinted}
                                                onChange={(e) => setNewDesign({...newDesign, isPrinted: e.target.checked})}
                                                className="w-5 h-5"
                                            />
                                            <label htmlFor="isPrinted" className="font-semibold text-gray-700">
                                                ¬øYa est√° impreso?
                                            </label>
                                        </div>
                                        <button
                                            onClick={handleAddDesign}
                                            className="w-full btn-primary text-white py-4 px-6 rounded-lg font-semibold text-lg"
                                        >
                                            ‚ú® Agregar Dise√±o
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Modal para ver imagen en grande */}
                        {viewImage && (
                            <div className="modal-overlay" onClick={() => setViewImage(null)}>
                                <div className="text-center">
                                    <img 
                                        src={viewImage} 
                                        alt="Vista ampliada" 
                                        className="modal-image"
                                    />
                                    <p className="text-white mt-4 text-sm">Click para cerrar</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<GestorDTF />, document.getElementById('root'));
    </script>
</body>
</html>