<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor DTF Cloud - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // ==================== CONFIGURACI√ìN FIREBASE ====================
        // PEGA TUS CREDENCIALES AQU√ç
        const firebaseConfig = {
            apiKey: "AIzaSyD8Zl-pSyzjqFMHj7YwGMm9FG1RGcXNYh4",
            authDomain: "gestor-dtf-d9beb.firebaseapp.com",
            projectId: "gestor-dtf-d9beb",
            storageBucket: "gestor-dtf-d9beb.firebasestorage.app",
            messagingSenderId: "2726810320",
            appId: "1:2726810320:web:d4e0930e98642cd5bc44d5"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ==================== ESTADO GLOBAL ====================
        let currentUser = null;
        let designs = [];
        let unsubscribe = null;

        // ==================== FUNCIONES DE AUTENTICACI√ìN ====================
        async function register(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                return { success: true, user: userCredential.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function login(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                return { success: true, user: userCredential.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                if (unsubscribe) unsubscribe();
                designs = [];
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // ==================== FUNCIONES DE FIRESTORE ====================
        function setupDesignsListener(userId) {
            const designsRef = collection(db, 'users', userId, 'designs');
            
            unsubscribe = onSnapshot(designsRef, (snapshot) => {
                designs = [];
                snapshot.forEach((doc) => {
                    designs.push({ id: doc.id, ...doc.data() });
                });
                renderApp();
            });
        }

        async function saveDesign(design) {
            try {
                const userId = currentUser.uid;
                const designsRef = collection(db, 'users', userId, 'designs');
                
                if (design.id) {
                    // Actualizar dise√±o existente
                    const designDoc = doc(db, 'users', userId, 'designs', design.id);
                    await updateDoc(designDoc, design);
                } else {
                    // Crear nuevo dise√±o
                    await addDoc(designsRef, design);
                }
                return { success: true };
            } catch (error) {
                console.error('Error guardando dise√±o:', error);
                return { success: false, error: error.message };
            }
        }

        async function deleteDesign(designId) {
            try {
                const userId = currentUser.uid;
                const designDoc = doc(db, 'users', userId, 'designs', designId);
                await deleteDoc(designDoc);
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function uploadImage(file, designCode) {
            try {
                const userId = currentUser.uid;
                const imageRef = ref(storage, `users/${userId}/designs/${designCode}-${Date.now()}.jpg`);
                
                // Comprimir imagen
                const compressedImage = await compressImage(file);
                
                // Subir a Firebase Storage
                await uploadString(imageRef, compressedImage, 'data_url');
                
                // Obtener URL de descarga
                const downloadURL = await getDownloadURL(imageRef);
                
                return { success: true, url: downloadURL };
            } catch (error) {
                console.error('Error subiendo imagen:', error);
                return { success: false, error: error.message };
            }
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const maxSize = 800;
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ==================== RENDERIZADO ====================
        function renderApp() {
            const root = document.getElementById('root');
            
            if (!currentUser) {
                root.innerHTML = renderLoginScreen();
            } else {
                root.innerHTML = renderMainApp();
            }
        }

        function renderLoginScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="glass p-8 max-w-md w-full">
                        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2 text-center">
                            üé® Gestor DTF Cloud
                        </h1>
                        <p class="text-gray-600 text-center mb-8">Tu inventario sincronizado en la nube</p>
                        
                        <div id="login-form">
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                <input type="email" id="email" class="w-full p-3 border-2 border-gray-300 rounded-lg" placeholder="tu@email.com">
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Contrase√±a</label>
                                <input type="password" id="password" class="w-full p-3 border-2 border-gray-300 rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            <button onclick="handleLogin()" class="w-full btn-primary text-white py-3 px-6 rounded-lg font-semibold mb-3">
                                üîê Iniciar Sesi√≥n
                            </button>
                            <button onclick="handleRegister()" class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-300">
                                ‚ú® Crear Cuenta Nueva
                            </button>
                            <div id="auth-message" class="mt-4 text-center text-sm"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            const stats = {
                total: designs.length,
                printed: designs.filter(d => d.isPrinted).length,
                notPrinted: designs.filter(d => !d.isPrinted).length,
                totalStock: designs.reduce((sum, d) => sum + (d.stock || 0), 0),
                lowStock: designs.filter(d => d.stock > 0 && d.stock <= 3).length,
                outOfStock: designs.filter(d => d.isPrinted && d.stock === 0).length
            };

            return `
                <div class="min-h-screen p-4">
                    <div class="max-w-7xl mx-auto">
                        <!-- Header -->
                        <div class="glass p-6 mb-6">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                                        üé® Gestor DTF Cloud
                                    </h1>
                                    <p class="text-gray-600">‚òÅÔ∏è Sincronizado en la nube ‚Ä¢ ${currentUser.email}</p>
                                </div>
                                <button onclick="handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-semibold text-sm">
                                    üö™ Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                            <div class="glass p-4">
                                <div class="text-2xl font-bold text-purple-600">${stats.total}</div>
                                <div class="text-sm text-gray-600">Total Dise√±os</div>
                            </div>
                            <div class="glass p-4">
                                <div class="text-2xl font-bold text-green-600">${stats.printed}</div>
                                <div class="text-sm text-gray-600">Ya Impresos</div>
                            </div>
                            <div class="glass p-4">
                                <div class="text-2xl font-bold text-red-600">${stats.notPrinted}</div>
                                <div class="text-sm text-gray-600">Sin Imprimir</div>
                            </div>
                            <div class="glass p-4">
                                <div class="text-2xl font-bold text-blue-600">${stats.totalStock}</div>
                                <div class="text-sm text-gray-600">Stock Total</div>
                            </div>
                            <div class="glass p-4">
                                <div class="text-2xl font-bold text-orange-600">${stats.lowStock}</div>
                                <div class="text-sm text-gray-600">Stock Bajo (‚â§3)</div>
                            </div>
                            <div class="glass p-4">
                                <div class="text-2xl font-bold text-red-700">${stats.outOfStock}</div>
                                <div class="text-sm text-gray-600">Agotados</div>
                            </div>
                        </div>

                        <!-- Inventory -->
                        <div class="glass p-6">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">üìö Inventario Completo</h2>
                            <input type="text" id="search" placeholder="üîç Buscar por c√≥digo, cliente o descripci√≥n..." 
                                   class="w-full p-4 border-2 border-gray-300 rounded-lg mb-6"
                                   oninput="handleSearch(this.value)">
                            
                            <div id="inventory-list" class="space-y-3 max-h-[600px] overflow-y-auto">
                                ${designs.length === 0 ? `
                                    <div class="text-center py-12 text-gray-500">
                                        ¬°A√∫n no tienes dise√±os! Agrega tu primer dise√±o.
                                    </div>
                                ` : designs.map(design => renderDesignCard(design)).join('')}
                            </div>

                            <button onclick="showAddDesignForm()" class="mt-6 w-full btn-primary text-white py-4 px-6 rounded-lg font-semibold text-lg">
                                ‚ûï Agregar Nuevo Dise√±o
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDesignCard(design) {
            const stockStatus = design.stock === 0 ? 'bg-red-100 border-red-300' : 
                               design.stock <= 3 ? 'bg-yellow-100 border-yellow-300' : 
                               'bg-white border-gray-200';
            
            return `
                <div class="border-2 rounded-lg p-4 ${stockStatus}">
                    <div class="flex gap-4">
                        ${design.imageUrl ? `
                            <img src="${design.imageUrl}" alt="${design.code}" class="w-20 h-20 object-cover rounded-lg cursor-pointer"
                                 onclick="viewImage('${design.imageUrl}')">
                        ` : ''}
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2 flex-wrap">
                                <span class="text-xl font-bold text-purple-600">${design.code}</span>
                                <span class="px-3 py-1 rounded-full text-xs ${design.isPrinted ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                                    ${design.isPrinted ? '‚úì IMPRESO' : '‚è≥ PENDIENTE'}
                                </span>
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${
                                    design.stock === 0 ? 'bg-red-500 text-white' :
                                    design.stock <= 3 ? 'bg-orange-500 text-white' :
                                    'bg-blue-500 text-white'
                                }">
                                    üì¶ Stock: ${design.stock || 0}
                                </span>
                            </div>
                            ${design.client ? `<div class="text-sm text-gray-700 mb-1"><span class="font-semibold">Cliente:</span> ${design.client}</div>` : ''}
                            ${design.description ? `<div class="text-sm text-gray-700 mb-1"><span class="font-semibold">Descripci√≥n:</span> ${design.description}</div>` : ''}
                            ${design.notes ? `<div class="text-sm text-gray-600 mb-1"><span class="font-semibold">Notas:</span> ${design.notes}</div>` : ''}
                            
                            <div class="mt-3 flex gap-2 flex-wrap">
                                <button onclick="addImage('${design.id}')" class="bg-purple-500 text-white px-3 py-1 rounded-lg hover:bg-purple-600 text-sm font-semibold">
                                    ${design.imageUrl ? 'üñºÔ∏è Cambiar Imagen' : 'üì∑ Agregar Imagen'}
                                </button>
                                <button onclick="addStock('${design.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 text-sm font-semibold">
                                    ‚ûï Agregar Stock
                                </button>
                                <button onclick="adjustStock('${design.id}')" class="bg-gray-500 text-white px-3 py-1 rounded-lg hover:bg-gray-600 text-sm font-semibold">
                                    ‚úèÔ∏è Ajustar
                                </button>
                                <button onclick="removeDesign('${design.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 text-sm font-semibold">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== EVENT HANDLERS ====================
        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const messageEl = document.getElementById('auth-message');
            
            if (!email || !password) {
                messageEl.innerHTML = '<span class="text-red-600">Por favor completa todos los campos</span>';
                return;
            }
            
            messageEl.innerHTML = '<span class="text-blue-600">Iniciando sesi√≥n...</span>';
            const result = await login(email, password);
            
            if (result.success) {
                messageEl.innerHTML = '<span class="text-green-600">‚úÖ Sesi√≥n iniciada!</span>';
            } else {
                messageEl.innerHTML = `<span class="text-red-600">‚ùå Error: ${result.error}</span>`;
            }
        };

        window.handleRegister = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const messageEl = document.getElementById('auth-message');
            
            if (!email || !password) {
                messageEl.innerHTML = '<span class="text-red-600">Por favor completa todos los campos</span>';
                return;
            }
            
            if (password.length < 6) {
                messageEl.innerHTML = '<span class="text-red-600">La contrase√±a debe tener al menos 6 caracteres</span>';
                return;
            }
            
            messageEl.innerHTML = '<span class="text-blue-600">Creando cuenta...</span>';
            const result = await register(email, password);
            
            if (result.success) {
                messageEl.innerHTML = '<span class="text-green-600">‚úÖ Cuenta creada! Iniciando sesi√≥n...</span>';
            } else {
                messageEl.innerHTML = `<span class="text-red-600">‚ùå Error: ${result.error}</span>`;
            }
        };

        window.handleLogout = async function() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                await logout();
            }
        };

        window.showAddDesignForm = function() {
            const code = prompt('C√≥digo del dise√±o:');
            if (!code) return;
            
            const design = {
                code: code.toUpperCase(),
                client: '',
                description: '',
                notes: '',
                isPrinted: false,
                stock: 0,
                imageUrl: null,
                createdAt: new Date().toISOString()
            };
            
            saveDesign(design);
        };

        window.addImage = async function(designId) {
            const design = designs.find(d => d.id === designId);
            if (!design) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (confirm('Subiendo imagen a la nube...')) {
                    const result = await uploadImage(file, design.code);
                    if (result.success) {
                        design.imageUrl = result.url;
                        await saveDesign(design);
                        alert('‚úÖ Imagen agregada!');
                    } else {
                        alert('‚ùå Error subiendo imagen');
                    }
                }
            };
            input.click();
        };

        window.addStock = async function(designId) {
            const design = designs.find(d => d.id === designId);
            if (!design) return;
            
            const qty = prompt(`Agregar stock a ${design.code}. ¬øCu√°ntas unidades?`, '10');
            if (!qty || isNaN(qty)) return;
            
            design.stock = (design.stock || 0) + parseInt(qty);
            design.isPrinted = true;
            design.lastPrinted = new Date().toISOString();
            await saveDesign(design);
        };

        window.adjustStock = async function(designId) {
            const design = designs.find(d => d.id === designId);
            if (!design) return;
            
            const qty = prompt(`Stock actual: ${design.stock}. Nuevo stock:`, design.stock);
            if (qty === null) return;
            
            design.stock = Math.max(0, parseInt(qty) || 0);
            await saveDesign(design);
        };

        window.removeDesign = async function(designId) {
            const design = designs.find(d => d.id === designId);
            if (!design) return;
            
            if (confirm(`¬øEliminar ${design.code}?`)) {
                await deleteDesign(designId);
            }
        };

        window.handleSearch = function(term) {
            // Implementar b√∫squeda en el cliente
            const filtered = designs.filter(d => 
                d.code.toLowerCase().includes(term.toLowerCase()) ||
                (d.client && d.client.toLowerCase().includes(term.toLowerCase())) ||
                (d.description && d.description.toLowerCase().includes(term.toLowerCase()))
            );
            
            const listEl = document.getElementById('inventory-list');
            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="text-center py-12 text-gray-500">No se encontraron dise√±os</div>';
            } else {
                listEl.innerHTML = filtered.map(design => renderDesignCard(design)).join('');
            }
        };

        window.viewImage = function(url) {
            window.open(url, '_blank');
        };

        // ==================== INICIALIZACI√ìN ====================
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                setupDesignsListener(user.uid);
            } else {
                renderApp();
            }
        });
    </script>
</body>
</html>