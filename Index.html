<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor DTF Cloud Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5C7E8F;
            --secondary: #A2A2A2;
            --light: #D4DDE2;
            --white: #FFFFFF;
            --dark: #2D3748;
        }
        * { font-family: 'Poppins', sans-serif; letter-spacing: 0.02em; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #5C7E8F 0%, #A2A2A2 100%); min-height: 100vh; margin: 0; }
        .glass { background: rgba(255,255,255,0.97); border-radius: 16px; box-shadow: 0 8px 32px rgba(92,126,143,0.15); border: 1px solid rgba(212,221,226,0.3); }
        .btn-primary { background: linear-gradient(135deg, #5C7E8F, #A2A2A2); color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.05em; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(92,126,143,0.4); }
        .btn-green { background: #10b981; color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; }
        .btn-blue { background: #3b82f6; color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; }
        .btn-red { background: #ef4444; color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; }
        .btn-orange { background: #f97316; color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; }
        .btn-purple { background: #9333ea; color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; }
        .btn-gray { background: #6b7280; color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; }
        input, textarea, select { border: 2px solid #D4DDE2; padding: 10px 14px; border-radius: 8px; font-family: 'Poppins', sans-serif; transition: border-color 0.3s; outline: none; }
        input:focus, textarea:focus { border-color: #5C7E8F; }
        .tab-active { background: linear-gradient(135deg, #5C7E8F, #A2A2A2); color: white; }
        .tab-inactive { background: #f3f4f6; color: #374151; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(92,126,143,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; cursor: pointer; }
        .modal-img { max-width: 90vw; max-height: 90vh; border-radius: 12px; object-fit: contain; }
        .img-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #D4DDE2; transition: transform 0.2s; }
        .img-thumb:hover { transform: scale(1.1); border-color: #5C7E8F; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .spinner { width: 40px; height: 40px; border: 4px solid #D4DDE2; border-top-color: #5C7E8F; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-overlay { position: fixed; inset: 0; background: rgba(92,126,143,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9998; gap: 16px; }
        .loading-text { color: white; font-size: 1.1rem; font-weight: 600; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #5C7E8F; border-radius: 3px; }
        
        /* Dark Mode */
        body.dark-mode { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        body.dark-mode .glass { background: rgba(30, 41, 59, 0.98); color: #e2e8f0; border-color: rgba(71, 85, 105, 0.5); }
        body.dark-mode input, body.dark-mode textarea { background: #1e293b; color: #e2e8f0; border-color: #475569; }
        body.dark-mode input::placeholder, body.dark-mode textarea::placeholder { color: #94a3b8; }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 { color: #f1f5f9; }
        body.dark-mode .tab-inactive { background: #334155; color: #cbd5e1; }
        body.dark-mode ::-webkit-scrollbar-track { background: #1e293b; }
        body.dark-mode ::-webkit-scrollbar-thumb { background: #475569; }
        body.dark-mode .history-folder { background: #1e293b !important; }
        body.dark-mode .history-folder:hover { background: #334155 !important; }
    </style>
</head>
<body>
<div id="app"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, query, addDoc, getDocs, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
// Storage no requerido - imÃ¡genes en Firestore base64

// â”€â”€ FIREBASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = initializeApp({
    apiKey: "AIzaSyD8Zl-pSyzjqFMHj7YwGMm9FG1RGcXNYh4",
    authDomain: "gestor-dtf-d9beb.firebaseapp.com",
    projectId: "gestor-dtf-d9beb",
    storageBucket: "gestor-dtf-d9beb.firebasestorage.app",
    messagingSenderId: "2726810320",
    appId: "1:2726810320:web:d4e0930e98642cd5bc44d5"
});
const auth = getAuth(app);
const db = getFirestore(app);
// Storage no requerido

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = null;
let designs = [];
let unsubscribe = null;
let activeTab = 'pedido';
let searchTerm = '';
let orderResults = null;
let deliveryHistory = [];
let imageModal = null;
let isProcessing = false;
let isLoading = true;
let loadingMessage = 'Conectando con Firebase...';
let authError = '';
let isDarkMode = false;

// â”€â”€ FIREBASE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveDeliveryHistory(orderData) {
    try {
        const historyRef = collection(db, 'users', currentUser.uid, 'deliveryHistory');
        await addDoc(historyRef, {
            ...orderData,
            timestamp: new Date().toISOString()
        });
        return true;
    } catch (e) {
        console.error('Error guardando historial:', e);
        return false;
    }
}

async function completeOrder() {
    if (!orderResults) {
        alert('Primero procesa un pedido');
        return;
    }
    
    const clientName = prompt('Nombre del cliente para este pedido:');
    if (!clientName || !clientName.trim()) {
        alert('Debes ingresar el nombre del cliente');
        return;
    }
    
    const historyEntry = {
        clientName: clientName.trim(),
        available: orderResults.available.map(a => ({ 
            code: a.design.code, 
            qty: a.qty,
            descriptions: a.descriptions || []
        })),
        outOfStock: orderResults.outOfStock.map(o => ({ 
            code: o.design.code, 
            qty: o.qty, 
            had: o.have,
            descriptions: o.descriptions || []
        })),
        notFound: orderResults.notFound.map(n => ({ 
            code: n.code, 
            qty: n.qty,
            descriptions: n.descriptions || []
        })),
        totalCodes: orderResults.available.length + orderResults.outOfStock.length + orderResults.notFound.length
    };
    
    const saved = await saveDeliveryHistory(historyEntry);
    if (saved) {
        alert(`âœ… Pedido de ${clientName} guardado en el historial!`);
        // Limpiar resultados y textarea
        orderResults = null;
        document.getElementById('orderCodes').value = '';
        await loadDeliveryHistory();
        render();
    }
}

async function loadDeliveryHistory() {
    try {
        const historyRef = collection(db, 'users', currentUser.uid, 'deliveryHistory');
        const q = query(historyRef, orderBy('timestamp', 'desc'), limit(50));
        const snap = await getDocs(q);
        deliveryHistory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (e) {
        console.error('Error cargando historial:', e);
        deliveryHistory = [];
    }
}

async function saveDesignCloud(design) {
    try {
        const ref = doc(db, 'users', currentUser.uid, 'designs', design.code);
        await setDoc(ref, design, { merge: true });
        return true;
    } catch (e) {
        console.error(e);
        if (e.code === 'permission-denied') {
            alert('âš ï¸ Permisos de Firestore. Activa las reglas en modo de prueba en Firebase Console.');
        }
        return false;
    }
}

async function deleteDesignCloud(code) {
    try {
        await deleteDoc(doc(db, 'users', currentUser.uid, 'designs', code));
        return true;
    } catch (e) { console.error(e); return false; }
}

async function uploadImageCloud(file, code) {
    try {
        const compressed = await compressImageTo1MB(file);
        const sizeKB = Math.round((compressed.length * 3/4) / 1024);
        console.log(`Imagen ${code}: ${sizeKB}KB`);
        return { success: true, url: compressed };
    } catch (e) {
        console.error(e);
        alert('âŒ Error procesando imagen');
        return { success: false };
    }
}

function compressImageTo1MB(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const tryCompress = (maxSize, quality) => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxSize || h > maxSize) {
                        if (w > h) { h = Math.round((h/w)*maxSize); w = maxSize; }
                        else { w = Math.round((w/h)*maxSize); h = maxSize; }
                    }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    const result = canvas.toDataURL('image/jpeg', quality);
                    // Check size in bytes (base64 * 3/4)
                    const bytes = (result.length * 3) / 4;
                    return { result, bytes };
                };

                // Try progressively until under 1MB (1,000,000 bytes)
                const attempts = [
                    { maxSize: 800, quality: 0.8 },
                    { maxSize: 700, quality: 0.7 },
                    { maxSize: 600, quality: 0.6 },
                    { maxSize: 500, quality: 0.5 },
                    { maxSize: 400, quality: 0.4 },
                    { maxSize: 300, quality: 0.3 },
                ];

                for (const attempt of attempts) {
                    const { result, bytes } = tryCompress(attempt.maxSize, attempt.quality);
                    if (bytes < 900000) { // Under 900KB to be safe
                        resolve(result);
                        return;
                    }
                }

                // Last resort - smallest possible
                const { result } = tryCompress(200, 0.2);
                resolve(result);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function setupListener(uid) {
    if (unsubscribe) unsubscribe();

    const timeout = setTimeout(() => {
        if (isLoading) {
            isLoading = false;
            authError = 'â±ï¸ La conexiÃ³n tardÃ³ demasiado. Verifica tu internet e intenta recargar la pÃ¡gina.';
            render();
        }
    }, 15000);

    const q = query(collection(db, 'users', uid, 'designs'));
    unsubscribe = onSnapshot(q, (snap) => {
        clearTimeout(timeout);
        designs = snap.docs.map(d => d.data());
        isLoading = false;
        render();
    }, (err) => {
        clearTimeout(timeout);
        console.error(err);
        isLoading = false;
        if (err.code === 'permission-denied') {
            authError = 'ğŸ”’ Sin permisos. Ve a Firebase â†’ Firestore â†’ Reglas y activa modo de prueba.';
        } else if (err.code === 'unavailable') {
            authError = 'ğŸ“¡ Sin conexiÃ³n a internet. Verifica tu red e intenta de nuevo.';
        } else {
            authError = `âŒ Error: ${err.message}. Recarga la pÃ¡gina.`;
        }
        render();
    });
}

function showError(msg) {
    isLoading = false;
    authError = msg;
    render();
}

// â”€â”€ EXPORT / IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportData() {
    const data = { designs, exportDate: new Date().toISOString(), version: '3.0' };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gestor-dtf-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    alert('âœ… Datos exportados correctamente.');
}

async function importData() {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                if (!data.designs || !Array.isArray(data.designs)) { alert('âŒ Archivo invÃ¡lido'); return; }
                if (!confirm(`Â¿Importar ${data.designs.length} diseÃ±os a la nube?\n\nEsto incluirÃ¡ imÃ¡genes si estÃ¡n en el archivo.`)) return;
                setLoading(true, `Importando ${data.designs.length} diseÃ±os a Firebase...`);
                for (const d of data.designs) { 
                    // Convertir image a imageUrl si existe
                    if (d.image && !d.imageUrl) {
                        d.imageUrl = d.image;
                        delete d.image;
                    }
                    await saveDesignCloud(d);
                }
                setLoading(false);
                alert(`âœ… ${data.designs.length} diseÃ±os importados con Ã©xito!`);
            } catch (e) { setLoading(false); alert('âŒ Error al importar: ' + e.message); }
        };
        reader.readAsText(file);
    };
    input.click();
}

function setLoading(val, msg = '') {
    isLoading = val;
    loadingMessage = msg;
    render();
}

// â”€â”€ OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let continuousScanActive = false;
let scannedCodes = [];

async function handleOCR() {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'image/*';
    input.onchange = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        await processOCRImage(file, false);
    };
    input.click();
}

async function handleContinuousScan() {
    if (continuousScanActive) {
        continuousScanActive = false;
        if (scannedCodes.length > 0) {
            document.getElementById('orderCodes').value = scannedCodes.join('\n');
            alert(`âœ… ${scannedCodes.length} cÃ³digos escaneados!`);
        }
        scannedCodes = [];
        render();
        return;
    }
    
    continuousScanActive = true;
    scannedCodes = [];
    alert('ğŸ“¹ Modo escaneo continuo activado.\n\nSelecciona fotos una por una.\nCuando termines, presiona el botÃ³n nuevamente para finalizar.');
    render();
    
    scanNextImage();
}

function scanNextImage() {
    if (!continuousScanActive) return;
    
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'image/*';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) {
            continuousScanActive = false;
            if (scannedCodes.length > 0) {
                document.getElementById('orderCodes').value = scannedCodes.join('\n');
                alert(`âœ… ${scannedCodes.length} cÃ³digos escaneados!`);
            }
            scannedCodes = [];
            render();
            return;
        }
        
        await processOCRImage(file, true);
        if (continuousScanActive) {
            setTimeout(() => scanNextImage(), 500);
        }
    };
    input.click();
}

async function processOCRImage(file, isContinuous) {
    setLoading(true, 'Procesando imagen con OCR...');
    try {
        const result = await Tesseract.recognize(file, 'eng');
        const extractedText = result.data.text;
        
        if (isContinuous) {
            scannedCodes.push(extractedText);
            setLoading(false);
            alert(`âœ“ Imagen ${scannedCodes.length} procesada.\n\nCÃ³digos escaneados hasta ahora: ${scannedCodes.length}\n\nSelecciona la siguiente imagen o cancela para terminar.`);
        } else {
            document.getElementById('orderCodes').value = extractedText;
            setLoading(false);
            alert('âœ… Texto extraÃ­do. Revisa y procesa el pedido.');
        }
    } catch {
        setLoading(false);
        alert('âŒ Error procesando imagen');
        if (isContinuous) {
            continuousScanActive = false;
            scannedCodes = [];
            render();
        }
    }
}

// â”€â”€ ORDER PROCESSING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function processOrder() {
    const codesText = document.getElementById('orderCodes')?.value || '';
    if (!codesText.trim()) { alert('Ingresa los cÃ³digos del pedido'); return; }
    const lines = codesText.trim().split('\n').filter(l => l.trim());
    const codeDetails = {}; // { code: { qty: number, descriptions: [] } }
    
    lines.forEach(line => {
        line = line.trim();
        
        // Ignorar lÃ­neas que son totales o comentarios
        if (line.startsWith('*') || line.toLowerCase().includes('total')) return;
        
        // Detectar si la lÃ­nea empieza con nombre de cliente (palabras seguidas de espacio y cÃ³digo)
        // Ejemplo: "Veraly flores Q190" o "RT02 verde talla M"
        const parts = line.split(/\s+/);
        if (parts.length === 0) return;
        
        let code = '';
        let description = '';
        
        // Buscar el cÃ³digo (generalmente formato: letras seguidas de nÃºmeros)
        // o puede estar al inicio o despuÃ©s del nombre
        const codePattern = /^[A-Z]+\d+/i;
        let codeIndex = -1;
        
        for (let i = 0; i < parts.length; i++) {
            if (codePattern.test(parts[i])) {
                code = parts[i].toUpperCase();
                codeIndex = i;
                break;
            }
        }
        
        // Si no encontramos cÃ³digo en formato estÃ¡ndar, intentar con "DiseÃ±o X"
        if (!code && line.toLowerCase().includes('diseÃ±o')) {
            // Extraer nÃºmero despuÃ©s de "diseÃ±o"
            const designMatch = line.match(/diseÃ±o\s+(\d+)/i);
            if (designMatch) {
                code = `DISEÃ‘O${designMatch[1]}`;
                description = line.replace(/diseÃ±o\s+\d+/i, '').trim();
            }
        }
        
        if (!code) {
            // Si aÃºn no hay cÃ³digo, tomar la primera palabra como cÃ³digo
            code = parts[0].toUpperCase();
            description = parts.slice(1).join(' ').trim();
        } else {
            // DescripciÃ³n es todo menos el cÃ³digo
            if (codeIndex === 0) {
                description = parts.slice(1).join(' ').trim();
            } else {
                // El cÃ³digo estÃ¡ despuÃ©s del nombre del cliente
                // Nombre + descripciÃ³n despuÃ©s del cÃ³digo
                description = parts.slice(codeIndex + 1).join(' ').trim();
            }
        }
        
        if (!codeDetails[code]) {
            codeDetails[code] = { qty: 0, descriptions: [] };
        }
        codeDetails[code].qty++;
        if (description) {
            codeDetails[code].descriptions.push(description);
        }
    });
    
    const available = [], outOfStock = [], notFound = [];
    Object.entries(codeDetails).forEach(([code, details]) => {
        const d = designs.find(x => x.code === code);
        if (!d) {
            notFound.push({ code, qty: details.qty, descriptions: details.descriptions });
        } else if ((d.stock || 0) >= details.qty) {
            available.push({ design: d, qty: details.qty, descriptions: details.descriptions });
        } else {
            outOfStock.push({ design: d, qty: details.qty, have: d.stock || 0, descriptions: details.descriptions });
        }
    });
    
    orderResults = { available, outOfStock, notFound };
    render();
}

async function deliverOrder(code, qty) {
    const d = designs.find(x => x.code === code);
    if (!d) return;
    d.stock = Math.max(0, (d.stock || 0) - qty);
    await saveDesignCloud(d);
    processOrder();
}

async function markPrinted(code) {
    const d = designs.find(x => x.code === code);
    if (!d) return;
    const qty = prompt(`Â¿CuÃ¡ntas unidades imprimir de ${code}?`, '10');
    if (!qty) return;
    d.stock = (d.stock || 0) + parseInt(qty);
    d.isPrinted = true;
    d.lastPrinted = new Date().toISOString();
    await saveDesignCloud(d);
    processOrder();
}

// â”€â”€ BULK IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bulkImport() {
    const textarea = document.getElementById('bulkImportCodes');
    const text = textarea?.value?.trim();
    if (!text) { alert('Pega los cÃ³digos primero'); return; }
    const codes = text.split(/[\n,;]+/).map(c => c.trim().toUpperCase()).filter(c => c);
    if (!confirm(`Â¿Importar ${codes.length} diseÃ±os?`)) return;
    setLoading(true, `Guardando ${codes.length} diseÃ±os en la nube...`);
    let imported = 0, skipped = 0;
    for (const code of codes) {
        if (designs.find(d => d.code === code)) { skipped++; continue; }
        await saveDesignCloud({ code, client: '', description: '', notes: '', isPrinted: false, stock: 0, imageUrl: null, createdAt: new Date().toISOString() });
        imported++;
    }
    setLoading(false);
    alert(`âœ… Importados: ${imported}\nâŠ˜ Ya existÃ­an: ${skipped}`);
    activeTab = 'inventario';
    render();
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
    const root = document.getElementById('app');
    if (!root) return;

    if (isLoading) {
        root.innerHTML = `
        <div class="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">${loadingMessage}</div>
        </div>`;
        return;
    }

    if (!currentUser) { root.innerHTML = renderLogin(); bindLoginEvents(); return; }
    root.innerHTML = renderMain();
    bindMainEvents();
}

function renderLogin() {
    return `
    <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px">
        <div class="glass" style="padding:40px;max-width:440px;width:100%">
            <h1 style="font-size:2rem;font-weight:900;color:#5C7E8F;text-align:center;margin-bottom:8px;letter-spacing:0.05em">GESTOR DTF CLOUD</h1>
            <p style="color:#A2A2A2;text-align:center;margin-bottom:32px;font-weight:500">Inventario sincronizado en la nube â˜ï¸</p>
            ${authError ? `<div style="background:#fee2e2;border:1px solid #ef4444;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-size:0.85rem">${authError}</div>` : ''}
            <div style="margin-bottom:16px">
                <label style="display:block;font-size:0.85rem;font-weight:600;margin-bottom:6px;color:#2D3748">Email</label>
                <input type="email" id="loginEmail" placeholder="tu@email.com" style="width:100%">
            </div>
            <div style="margin-bottom:24px">
                <label style="display:block;font-size:0.85rem;font-weight:600;margin-bottom:6px;color:#2D3748">ContraseÃ±a</label>
                <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%">
            </div>
            <button id="btnLogin" class="btn-primary" style="width:100%;padding:14px;border-radius:10px;font-size:1rem;margin-bottom:10px">ğŸ” Iniciar SesiÃ³n</button>
            <button id="btnRegister" style="width:100%;padding:14px;border-radius:10px;font-size:0.9rem;background:#f3f4f6;color:#374151;border:none;cursor:pointer;font-weight:600;font-family:Poppins,sans-serif">âœ¨ Crear Cuenta Nueva</button>
            <div id="authMsg" style="margin-top:12px;text-align:center;font-size:0.85rem"></div>
        </div>
    </div>`;
}

function bindLoginEvents() {
    document.getElementById('btnLogin')?.addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPassword').value;
        const msg = document.getElementById('authMsg');
        if (!email || !pass) { msg.innerHTML = '<span style="color:#ef4444">Completa todos los campos</span>'; return; }
        msg.innerHTML = '<span style="color:#5C7E8F">Iniciando sesiÃ³n...</span>';
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (e) {
            const errors = { 'auth/user-not-found': 'Usuario no encontrado', 'auth/wrong-password': 'ContraseÃ±a incorrecta', 'auth/invalid-email': 'Email invÃ¡lido', 'auth/invalid-credential': 'Credenciales incorrectas' };
            msg.innerHTML = `<span style="color:#ef4444">âŒ ${errors[e.code] || e.message}</span>`;
        }
    });
    document.getElementById('btnRegister')?.addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPassword').value;
        const msg = document.getElementById('authMsg');
        if (!email || !pass) { msg.innerHTML = '<span style="color:#ef4444">Completa todos los campos</span>'; return; }
        if (pass.length < 6) { msg.innerHTML = '<span style="color:#ef4444">MÃ­nimo 6 caracteres</span>'; return; }
        msg.innerHTML = '<span style="color:#5C7E8F">Creando cuenta...</span>';
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
        } catch (e) {
            const errors = { 'auth/email-already-in-use': 'Email ya registrado', 'auth/invalid-email': 'Email invÃ¡lido', 'auth/weak-password': 'ContraseÃ±a muy dÃ©bil' };
            msg.innerHTML = `<span style="color:#ef4444">âŒ ${errors[e.code] || e.message}</span>`;
        }
    });
}

function renderMain() {
    const stats = {
        total: designs.length,
        printed: designs.filter(d => d.isPrinted).length,
        notPrinted: designs.filter(d => !d.isPrinted).length,
        totalStock: designs.reduce((s, d) => s + (d.stock || 0), 0),
        lowStock: designs.filter(d => (d.stock || 0) > 0 && (d.stock || 0) <= 3).length,
        outOfStock: designs.filter(d => d.isPrinted && (d.stock || 0) === 0).length
    };

    const filtered = designs.filter(d =>
        d.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (d.client && d.client.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (d.description && d.description.toLowerCase().includes(searchTerm.toLowerCase()))
    );

    return `
    ${imageModal ? `<div class="modal-overlay" id="imgModal"><img src="${imageModal}" class="modal-img"></div>` : ''}
    <div style="min-height:100vh;padding:16px">
    <div style="max-width:1200px;margin:0 auto">

        <!-- HEADER -->
        <div class="glass" style="padding:24px;margin-bottom:24px">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                <div>
                    <h1 style="font-size:2.2rem;font-weight:900;color:#5C7E8F;margin:0;letter-spacing:0.05em">GESTOR DTF PRO</h1>
                    <p style="color:#A2A2A2;margin:4px 0 0;font-weight:500;font-size:0.9rem">â˜ï¸ Sincronizado â€¢ ${currentUser.email}</p>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button id="btnDarkMode" class="btn-gray" style="padding:8px 16px;border-radius:8px;font-size:0.85rem">${isDarkMode ? 'â˜€ï¸ Claro' : 'ğŸŒ™ Oscuro'}</button>
                    <button id="btnExport" class="btn-green" style="padding:8px 16px;border-radius:8px;font-size:0.85rem">ğŸ’¾ Exportar</button>
                    <button id="btnImport" class="btn-blue" style="padding:8px 16px;border-radius:8px;font-size:0.85rem">ğŸ“‚ Importar</button>
                    <button id="btnLogout" class="btn-red" style="padding:8px 16px;border-radius:8px;font-size:0.85rem">ğŸšª Salir</button>
                </div>
            </div>
        </div>

        <!-- STATS -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin-bottom:24px">
            <div class="glass" style="padding:20px;background:#5C7E8F;color:white;border-radius:16px">
                <div style="font-size:2rem;font-weight:800">${stats.total}</div>
                <div style="font-size:0.8rem;opacity:0.9;font-weight:500">Total DiseÃ±os</div>
            </div>
            <div class="glass" style="padding:20px;background:#10b981;color:white;border-radius:16px">
                <div style="font-size:2rem;font-weight:800">${stats.printed}</div>
                <div style="font-size:0.8rem;opacity:0.9;font-weight:500">Ya Impresos</div>
            </div>
            <div class="glass" style="padding:20px;background:#ef4444;color:white;border-radius:16px">
                <div style="font-size:2rem;font-weight:800">${stats.notPrinted}</div>
                <div style="font-size:0.8rem;opacity:0.9;font-weight:500">Sin Imprimir</div>
            </div>
            <div class="glass" style="padding:20px;background:#3b82f6;color:white;border-radius:16px">
                <div style="font-size:2rem;font-weight:800">${stats.totalStock}</div>
                <div style="font-size:0.8rem;opacity:0.9;font-weight:500">Stock Total</div>
            </div>
            <div class="glass" style="padding:20px;background:#f97316;color:white;border-radius:16px">
                <div style="font-size:2rem;font-weight:800">${stats.lowStock}</div>
                <div style="font-size:0.8rem;opacity:0.9;font-weight:500">Stock Bajo (â‰¤3)</div>
            </div>
            <div class="glass" style="padding:20px;background:#dc2626;color:white;border-radius:16px">
                <div style="font-size:2rem;font-weight:800">${stats.outOfStock}</div>
                <div style="font-size:0.8rem;opacity:0.9;font-weight:500">Agotados</div>
            </div>
        </div>

        <!-- TABS -->
        <div class="glass" style="padding:8px;margin-bottom:24px;display:flex;gap:8px;flex-wrap:wrap">
            <button data-tab="pedido" class="tab-btn ${activeTab==='pedido'?'tab-active':'tab-inactive'}" style="flex:1;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.05em;font-family:Poppins,sans-serif">ğŸ“¦ Procesar Pedido</button>
            <button data-tab="inventario" class="tab-btn ${activeTab==='inventario'?'tab-active':'tab-inactive'}" style="flex:1;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.05em;font-family:Poppins,sans-serif">ğŸ“š Inventario</button>
            <button data-tab="reportes" class="tab-btn ${activeTab==='reportes'?'tab-active':'tab-inactive'}" style="flex:1;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.05em;font-family:Poppins,sans-serif">ğŸ“Š Reportes</button>
            <button data-tab="historial" class="tab-btn ${activeTab==='historial'?'tab-active':'tab-inactive'}" style="flex:1;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.05em;font-family:Poppins,sans-serif">ğŸ“‹ Historial</button>
            <button data-tab="importar" class="tab-btn ${activeTab==='importar'?'tab-active':'tab-inactive'}" style="flex:1;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.05em;font-family:Poppins,sans-serif">ğŸ“¥ Importar Masivo</button>
            <button data-tab="nuevo" class="tab-btn ${activeTab==='nuevo'?'tab-active':'tab-inactive'}" style="flex:1;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.05em;font-family:Poppins,sans-serif">â• Nuevo DiseÃ±o</button>
        </div>

        <!-- TAB CONTENT -->
        <div class="glass slide-in" style="padding:24px">
            ${activeTab === 'pedido' ? renderOrderTab() : ''}
            ${activeTab === 'inventario' ? renderInventoryTab(filtered) : ''}
            ${activeTab === 'reportes' ? renderReportesTab() : ''}
            ${activeTab === 'historial' ? renderHistorialTab() : ''}
            ${activeTab === 'importar' ? renderBulkImportTab() : ''}
            ${activeTab === 'nuevo' ? renderNewDesignTab() : ''}
        </div>

    </div></div>`;
}

function renderOrderTab() {
    return `
    <h2 style="font-size:1.5rem;font-weight:700;color:#2D3748;margin-bottom:20px">ğŸ“¦ Procesar Pedido</h2>
    <div style="background:#D4DDE2;padding:16px;border-radius:12px;margin-bottom:16px">
        <h3 style="color:#5C7E8F;font-weight:700;margin-bottom:8px">ğŸ“¸ OpciÃ³n 1: Escanear Imagen (OCR)</h3>
        <p style="font-size:0.85rem;color:#2D3748;margin-bottom:12px">Sube una foto del pedido y extraemos los cÃ³digos automÃ¡ticamente.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnOCR" class="btn-primary" style="padding:10px 20px;border-radius:8px">ğŸ“· Subir Foto</button>
            <button id="btnContinuousScan" class="${continuousScanActive ? 'btn-red' : 'btn-purple'}" style="padding:10px 20px;border-radius:8px">${continuousScanActive ? 'â¹ï¸ Detener Escaneo (' + scannedCodes.length + ')' : 'ğŸ“¹ Modo Escaneo Continuo'}</button>
        </div>
    </div>
    <div style="background:#fef3c7;padding:16px;border-radius:12px;margin-bottom:16px">
        <h3 style="color:#92400e;font-weight:700;margin-bottom:8px">âœï¸ OpciÃ³n 2: Copiar y Pegar</h3>
        <p style="font-size:0.85rem;color:#92400e;margin-bottom:12px">Pega los cÃ³digos del pedido, uno por lÃ­nea.</p>
        <textarea id="orderCodes" placeholder="RT01&#10;DM06&#10;PT02&#10;..." style="width:100%;height:180px;font-family:monospace;font-size:0.9rem;border-color:#f59e0b"></textarea>
    </div>
    <button id="btnProcess" class="btn-primary" style="width:100%;padding:16px;border-radius:10px;font-size:1rem;margin-bottom:20px">âš¡ Procesar Pedido</button>
    ${orderResults ? `
        <button id="btnCompleteOrder" class="btn-green" style="width:100%;padding:16px;border-radius:10px;font-size:1rem;margin-bottom:20px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em">
            âœ… Pedido Completado
        </button>
        ${renderOrderResults()}
    ` : ''}`;
}

function renderOrderResults() {
    const { available, outOfStock, notFound } = orderResults;
    let html = '';
    if (available.length > 0) {
        html += `<div style="background:#d1fae5;border:2px solid #10b981;padding:16px;border-radius:12px;margin-bottom:12px">
            <h3 style="color:#065f46;font-weight:700;margin-bottom:12px">âœ… DISPONIBLES EN STOCK (${available.length})</h3>
            ${available.map(({design, qty}) => `
            <div style="background:white;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                ${design.imageUrl ? `<img src="${design.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:6px">` : ''}
                <div style="flex:1"><span style="font-weight:700;font-size:1.1rem">${design.code}</span><span style="font-size:0.85rem;color:#666;margin-left:12px">Stock: ${design.stock} | Necesitas: ${qty}</span></div>
                <button class="btn-green deliver-btn" data-code="${design.code}" data-qty="${qty}" style="padding:8px 16px;border-radius:8px;font-size:0.85rem">âœ“ Entregar (${qty})</button>
            </div>`).join('')}
        </div>`;
    }
    if (outOfStock.length > 0) {
        html += `<div style="background:#fee2e2;border:2px solid #ef4444;padding:16px;border-radius:12px;margin-bottom:12px">
            <h3 style="color:#991b1b;font-weight:700;margin-bottom:12px">ğŸš¨ SIN STOCK (${outOfStock.length})</h3>
            ${outOfStock.map(({design, qty, have}) => `
            <div style="background:white;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                ${design.imageUrl ? `<img src="${design.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:6px">` : ''}
                <div style="flex:1"><span style="font-weight:700;font-size:1.1rem">${design.code}</span><span style="font-size:0.85rem;color:#666;margin-left:12px">Tienes: ${have} | Necesitas: ${qty}</span></div>
                <button class="btn-red print-btn" data-code="${design.code}" style="padding:8px 16px;border-radius:8px;font-size:0.85rem">ğŸ–¨ï¸ Ya ImprimÃ­</button>
            </div>`).join('')}
        </div>`;
    }
    if (notFound.length > 0) {
        html += `<div style="background:#fef3c7;border:2px solid #f59e0b;padding:16px;border-radius:12px">
            <h3 style="color:#92400e;font-weight:700;margin-bottom:12px">âš ï¸ NO ENCONTRADOS (${notFound.length})</h3>
            ${notFound.map(({code, qty}) => `
            <div style="background:white;padding:12px;border-radius:8px;margin-bottom:8px">
                <span style="font-weight:700;font-size:1.1rem">${code}</span><span style="font-size:0.85rem;color:#666;margin-left:12px">Cantidad: ${qty}</span>
            </div>`).join('')}
        </div>`;
    }
    return html;
}

function renderInventoryTab(filtered) {
    return `
    <h2 style="font-size:1.5rem;font-weight:700;color:#2D3748;margin-bottom:20px">ğŸ“š Inventario Completo</h2>
    <input type="text" id="searchInput" placeholder="ğŸ” Buscar por cÃ³digo, cliente o descripciÃ³n..." value="${searchTerm}" style="width:100%;margin-bottom:20px;font-size:1rem">
    <div style="max-height:600px;overflow-y:auto;display:flex;flex-direction:column;gap:12px">
        ${filtered.length === 0 ? `<div style="text-align:center;padding:48px;color:#A2A2A2">Â¡AÃºn no tienes diseÃ±os! Usa "Importar Masivo" o "Nuevo DiseÃ±o".</div>` : 
        filtered.map(d => `
        <div style="border:2px solid ${(d.stock||0)===0&&d.isPrinted?'#fca5a5':(d.stock||0)<=3&&(d.stock||0)>0?'#fcd34d':'#e5e7eb'};border-radius:12px;padding:16px;background:${(d.stock||0)===0&&d.isPrinted?'#fef2f2':(d.stock||0)<=3&&(d.stock||0)>0?'#fffbeb':'white'}">
            <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
                ${d.imageUrl ? `<img src="${d.imageUrl}" class="img-thumb view-img" data-url="${d.imageUrl}">` : ''}
                <div style="flex:1">
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px">
                        <span style="font-size:1.2rem;font-weight:800;color:#5C7E8F">${d.code}</span>
                        <span style="padding:3px 10px;border-radius:20px;font-size:0.75rem;font-weight:700;color:white;background:${d.isPrinted?'#10b981':'#ef4444'}">${d.isPrinted?'âœ“ IMPRESO':'â³ PENDIENTE'}</span>
                        <span style="padding:3px 10px;border-radius:20px;font-size:0.75rem;font-weight:700;color:white;background:${(d.stock||0)===0?'#ef4444':(d.stock||0)<=3?'#f97316':'#3b82f6'}">ğŸ“¦ Stock: ${d.stock||0}</span>
                    </div>
                    ${d.client ? `<div style="font-size:0.85rem;color:#374151;margin-bottom:4px"><strong>Cliente:</strong> ${d.client}</div>` : ''}
                    ${d.description ? `<div style="font-size:0.85rem;color:#374151;margin-bottom:4px"><strong>Desc:</strong> ${d.description}</div>` : ''}
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
                        <button class="btn-purple add-img-btn" data-code="${d.code}" style="padding:6px 12px;border-radius:6px;font-size:0.78rem">${d.imageUrl?'ğŸ–¼ï¸ Cambiar Imagen':'ğŸ“· Agregar Imagen'}</button>
                        <button class="btn-blue add-stock-btn" data-code="${d.code}" style="padding:6px 12px;border-radius:6px;font-size:0.78rem">â• Agregar Stock</button>
                        <button class="btn-gray adj-stock-btn" data-code="${d.code}" data-stock="${d.stock||0}" style="padding:6px 12px;border-radius:6px;font-size:0.78rem">âœï¸ Ajustar</button>
                        <button class="btn-red del-btn" data-code="${d.code}" style="padding:6px 12px;border-radius:6px;font-size:0.78rem">ğŸ—‘ï¸ Eliminar</button>
                    </div>
                </div>
            </div>
        </div>`).join('')}
    </div>`;
}

function renderReportesTab() {
    // Calcular estadÃ­sticas de ventas
    const salesStats = {};
    const clientStats = {};
    
    deliveryHistory.forEach(h => {
        // EstadÃ­sticas por diseÃ±o
        [...(h.available || []), ...(h.outOfStock || [])].forEach(item => {
            if (!salesStats[item.code]) {
                salesStats[item.code] = { code: item.code, totalSold: 0, timesOrdered: 0 };
            }
            salesStats[item.code].totalSold += item.qty;
            salesStats[item.code].timesOrdered++;
        });
        
        // EstadÃ­sticas por cliente
        const clientName = h.clientName || 'Sin nombre';
        if (!clientStats[clientName]) {
            clientStats[clientName] = { name: clientName, totalOrders: 0, totalItems: 0 };
        }
        clientStats[clientName].totalOrders++;
        clientStats[clientName].totalItems += h.totalCodes;
    });
    
    const topDesigns = Object.values(salesStats).sort((a, b) => b.totalSold - a.totalSold).slice(0, 10);
    const topClients = Object.values(clientStats).sort((a, b) => b.totalOrders - a.totalOrders).slice(0, 10);
    
    return `
    <h2 style="font-size:1.5rem;font-weight:700;color:#2D3748;margin-bottom:20px">ğŸ“Š Reportes y AnÃ¡lisis</h2>
    
    <!-- BÃºsqueda de Cliente -->
    <div style="background:#D4DDE2;padding:20px;border-radius:12px;margin-bottom:24px">
        <h3 style="color:#5C7E8F;font-weight:700;margin-bottom:12px;font-size:1.1rem">ğŸ” Buscar Pedidos por Cliente</h3>
        <input type="text" id="clientSearch" placeholder="Escribe el nombre del cliente..." style="width:100%;padding:12px;border-radius:8px;font-size:1rem;margin-bottom:12px">
        <div id="clientSearchResults"></div>
    </div>
    
    <!-- DiseÃ±os MÃ¡s Vendidos -->
    <div style="background:white;padding:20px;border-radius:12px;margin-bottom:24px;border:2px solid #D4DDE2">
        <h3 style="color:#5C7E8F;font-weight:700;margin-bottom:16px;font-size:1.1rem">ğŸ† Top 10 DiseÃ±os MÃ¡s Vendidos & Rentabilidad</h3>
        ${topDesigns.length === 0 ? `
            <p style="color:#A2A2A2;text-align:center;padding:20px">No hay datos de ventas aÃºn</p>
        ` : `
            <div style="display:grid;gap:12px">
                ${topDesigns.map((stat, idx) => {
                    const design = designs.find(d => d.code === stat.code);
                    const avgPerOrder = (stat.totalSold / stat.timesOrdered).toFixed(1);
                    const velocidad = stat.timesOrdered >= 5 ? 'ğŸ”¥ Alta demanda' : 
                                     stat.timesOrdered >= 2 ? 'ğŸ“ˆ Demanda media' : 
                                     'ğŸ“Š Demanda baja';
                    const velocidadColor = stat.timesOrdered >= 5 ? '#10b981' : 
                                          stat.timesOrdered >= 2 ? '#f59e0b' : 
                                          '#6b7280';
                    const rotacion = design && design.stock > 0 ? 
                                    (stat.totalSold / (design.stock + stat.totalSold) * 100).toFixed(0) : 100;
                    
                    return `
                    <div style="display:flex;gap:12px;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb">
                        <div style="background:#5C7E8F;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem">${idx + 1}</div>
                        ${design && design.imageUrl ? `<img src="${design.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;border:1px solid #D4DDE2">` : ''}
                        <div style="flex:1">
                            <div style="font-weight:700;color:#2D3748;font-size:1rem;margin-bottom:4px">${stat.code}</div>
                            <div style="display:flex;gap:12px;flex-wrap:wrap;font-size:0.8rem">
                                <span style="color:#6b7280">ğŸ“¦ ${stat.totalSold} vendidos en ${stat.timesOrdered} pedidos</span>
                                <span style="color:#6b7280">ğŸ“Š Promedio: ${avgPerOrder}/pedido</span>
                                <span style="color:${velocidadColor};font-weight:600">${velocidad}</span>
                                <span style="color:#5C7E8F;font-weight:600">â™»ï¸ RotaciÃ³n: ${rotacion}%</span>
                            </div>
                        </div>
                        ${design ? `
                            <div style="text-align:right">
                                <div style="font-size:0.75rem;color:#6b7280">Stock actual</div>
                                <div style="font-weight:700;font-size:1.1rem;color:${(design.stock||0)===0?'#ef4444':(design.stock||0)<=3?'#f97316':'#10b981'}">${design.stock||0}</div>
                                ${(design.stock||0) === 0 && stat.timesOrdered >= 3 ? '<div style="font-size:0.7rem;color:#ef4444;font-weight:600;margin-top:2px">âš ï¸ Reimprimir ya!</div>' : ''}
                            </div>
                        ` : ''}
                    </div>
                `}).join('')}
            </div>
        `}
    </div>
    
    <!-- Clientes Frecuentes -->
    <div style="background:white;padding:20px;border-radius:12px;border:2px solid #D4DDE2">
        <h3 style="color:#5C7E8F;font-weight:700;margin-bottom:16px;font-size:1.1rem">ğŸ‘¥ Top 10 Clientes Frecuentes</h3>
        ${topClients.length === 0 ? `
            <p style="color:#A2A2A2;text-align:center;padding:20px">No hay datos de clientes aÃºn</p>
        ` : `
            <div style="display:grid;gap:12px">
                ${topClients.map((stat, idx) => `
                    <div style="display:flex;gap:12px;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb">
                        <div style="background:#3b82f6;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem">${idx + 1}</div>
                        <div style="flex:1">
                            <div style="font-weight:700;color:#2D3748;font-size:1rem">${stat.name}</div>
                            <div style="font-size:0.85rem;color:#6b7280">${stat.totalOrders} pedidos â€¢ ${stat.totalItems} cÃ³digos totales</div>
                        </div>
                        <button class="btn-blue search-client-btn" data-client="${stat.name}" style="padding:8px 16px;border-radius:8px;font-size:0.85rem;font-weight:600">Ver Pedidos</button>
                    </div>
                `).join('')}
            </div>
        `}
    </div>
    `;
}

function renderHistoryContent(h) {
    return `
        ${h.available && h.available.length > 0 ? `
            <div style="background:#d1fae5;padding:12px;border-radius:8px;margin-bottom:8px">
                <div style="font-weight:700;color:#065f46;margin-bottom:8px;font-size:0.9rem">âœ… Entregados (${h.available.length})</div>
                <div style="display:flex;flex-direction:column;gap:6px">
                    ${h.available.map(a => {
                        const design = designs.find(d => d.code === a.code);
                        return `
                        <div style="background:white;padding:8px 12px;border-radius:6px;display:flex;gap:10px;align-items:center">
                            ${design && design.imageUrl ? `<img src="${design.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #d1fae5">` : ''}
                            <div style="flex:1">
                                <div>
                                    <span style="font-weight:700;color:#065f46">${a.code}</span>
                                    <span style="color:#6b7280;font-size:0.85rem"> x${a.qty}</span>
                                </div>
                                ${a.descriptions && a.descriptions.length > 0 ? `
                                    <div style="margin-top:4px;display:flex;flex-direction:column;gap:2px">
                                        ${a.descriptions.map(desc => `<span style="font-size:0.8rem;color:#059669;font-style:italic">â†’ ${desc}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            </div>
        ` : ''}
        
        ${h.outOfStock && h.outOfStock.length > 0 ? `
            <div style="background:#fee2e2;padding:12px;border-radius:8px;margin-bottom:8px">
                <div style="font-weight:700;color:#991b1b;margin-bottom:8px;font-size:0.9rem">ğŸš¨ Sin Stock (${h.outOfStock.length})</div>
                <div style="display:flex;flex-direction:column;gap:6px">
                    ${h.outOfStock.map(o => {
                        const design = designs.find(d => d.code === o.code);
                        return `
                        <div style="background:white;padding:8px 12px;border-radius:6px;display:flex;gap:10px;align-items:center">
                            ${design && design.imageUrl ? `<img src="${design.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #fee2e2">` : ''}
                            <div style="flex:1">
                                <div>
                                    <span style="font-weight:700;color:#991b1b">${o.code}</span>
                                    <span style="color:#6b7280;font-size:0.85rem"> x${o.qty} (habÃ­a: ${o.had})</span>
                                </div>
                                ${o.descriptions && o.descriptions.length > 0 ? `
                                    <div style="margin-top:4px;display:flex;flex-direction:column;gap:2px">
                                        ${o.descriptions.map(desc => `<span style="font-size:0.8rem;color:#dc2626;font-style:italic">â†’ ${desc}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            </div>
        ` : ''}
        
        ${h.notFound && h.notFound.length > 0 ? `
            <div style="background:#fef3c7;padding:12px;border-radius:8px">
                <div style="font-weight:700;color:#92400e;margin-bottom:8px;font-size:0.9rem">âš ï¸ No Encontrados (${h.notFound.length})</div>
                <div style="display:flex;flex-direction:column;gap:6px">
                    ${h.notFound.map(n => `
                        <div style="background:white;padding:8px 12px;border-radius:6px">
                            <span style="font-weight:700;color:#92400e">${n.code}</span>
                            <span style="color:#6b7280;font-size:0.85rem"> x${n.qty}</span>
                            ${n.descriptions && n.descriptions.length > 0 ? `
                                <div style="margin-top:4px;display:flex;flex-direction:column;gap:2px">
                                    ${n.descriptions.map(desc => `<span style="font-size:0.8rem;color:#d97706;font-style:italic">â†’ ${desc}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
    `;
}

function renderHistorialTab() {
    return `
    <h2 style="font-size:1.5rem;font-weight:700;color:#2D3748;margin-bottom:20px">ğŸ“‹ Historial de Entregas</h2>
    
    <!-- Buscador de Historial -->
    <input type="text" id="historySearch" placeholder="ğŸ” Buscar por cliente, cÃ³digo o fecha..." 
           style="width:100%;padding:12px;border-radius:8px;font-size:1rem;margin-bottom:20px;border:2px solid #D4DDE2">
    
    ${deliveryHistory.length === 0 ? `
        <div style="text-align:center;padding:48px;color:#A2A2A2">
            No hay entregas registradas aÃºn. Procesa tu primer pedido para verlo aquÃ­.
        </div>
    ` : `
        <div id="historyList" style="max-height:600px;overflow-y:auto;display:flex;flex-direction:column;gap:12px">
            ${deliveryHistory.map((h, idx) => {
                const date = new Date(h.timestamp);
                const dateStr = date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                
                return `
                <div style="border:2px solid #D4DDE2;border-radius:12px;overflow:hidden;background:white">
                    <!-- Folder Header (Clickable) -->
                    <div class="history-folder" data-index="${idx}" style="padding:16px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:#f9fafb;transition:background 0.2s">
                        <div style="flex:1">
                            <div style="font-weight:700;font-size:1.1rem;color:#5C7E8F;margin-bottom:4px">ğŸ“ ${h.clientName || 'Sin nombre'}</div>
                            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                                <span style="font-size:0.85rem;color:#6b7280">${dateStr} â€¢ ${timeStr}</span>
                                <span style="background:#5C7E8F;color:white;padding:2px 10px;border-radius:20px;font-size:0.75rem;font-weight:600">${h.totalCodes} cÃ³digos</span>
                            </div>
                        </div>
                        <span style="font-size:1.5rem;color:#5C7E8F">â–¼</span>
                    </div>
                    
                    <!-- Folder Content (Hidden by default) -->
                    <div id="history-content-${idx}" style="display:none;padding:16px;border-top:1px solid #e5e7eb;max-height:4000px;overflow-y:scroll;overflow-x:hidden;-webkit-overflow-scrolling:touch">
                        ${renderHistoryContent(h)}
                    </div>
                </div>
                `;
            }).join('')}
        </div>
    `}`;
}

function renderBulkImportTab() {
    return `
    <h2 style="font-size:1.5rem;font-weight:700;color:#2D3748;margin-bottom:20px">ğŸ“¥ ImportaciÃ³n Masiva de DiseÃ±os</h2>
    <div style="background:#D4DDE2;padding:16px;border-radius:12px;margin-bottom:16px">
        <h3 style="color:#5C7E8F;font-weight:700;margin-bottom:8px">Â¿CÃ³mo funciona?</h3>
        <p style="font-size:0.85rem;color:#2D3748;margin-bottom:4px">Pega una lista de cÃ³digos (uno por lÃ­nea) y se guardarÃ¡n automÃ¡ticamente en la nube.</p>
        <p style="font-size:0.8rem;color:#A2A2A2">Todos quedarÃ¡n como "Por imprimir" con stock 0.</p>
    </div>
    <textarea id="bulkImportCodes" placeholder="RT01&#10;RT02&#10;DM06&#10;TYT01&#10;PT01&#10;..." style="width:100%;height:280px;font-family:monospace;font-size:0.9rem;margin-bottom:16px"></textarea>
    <button id="btnBulkImport" class="btn-primary" style="width:100%;padding:16px;border-radius:10px;font-size:1rem">âš¡ Importar Todos a la Nube</button>`;
}

function renderNewDesignTab() {
    return `
    <h2 style="font-size:1.5rem;font-weight:700;color:#2D3748;margin-bottom:20px">â• Agregar Nuevo DiseÃ±o</h2>
    <div style="display:flex;flex-direction:column;gap:16px">
        <div>
            <label style="display:block;font-size:0.85rem;font-weight:600;margin-bottom:6px;color:#2D3748">CÃ³digo *</label>
            <input type="text" id="newCode" placeholder="Ej: RT01" style="width:100%">
        </div>
        <div>
            <label style="display:block;font-size:0.85rem;font-weight:600;margin-bottom:6px;color:#2D3748">Cliente</label>
            <input type="text" id="newClient" placeholder="Nombre del cliente" style="width:100%">
        </div>
        <div>
            <label style="display:block;font-size:0.85rem;font-weight:600;margin-bottom:6px;color:#2D3748">DescripciÃ³n</label>
            <input type="text" id="newDesc" placeholder="DescripciÃ³n del diseÃ±o" style="width:100%">
        </div>
        <div>
            <label style="display:block;font-size:0.85rem;font-weight:600;margin-bottom:6px;color:#2D3748">Notas</label>
            <textarea id="newNotes" placeholder="Notas adicionales" style="width:100%;height:80px"></textarea>
        </div>
        <div>
            <label style="display:block;font-size:0.85rem;font-weight:600;margin-bottom:6px;color:#2D3748">Stock Inicial</label>
            <input type="number" id="newStock" value="0" min="0" style="width:100%">
        </div>
        <div style="display:flex;align-items:center;gap:10px">
            <input type="checkbox" id="newPrinted" style="width:18px;height:18px">
            <label for="newPrinted" style="font-size:0.9rem;font-weight:600;color:#2D3748">Â¿Ya estÃ¡ impreso?</label>
        </div>
        <button id="btnSaveNew" class="btn-primary" style="padding:16px;border-radius:10px;font-size:1rem">âœ“ Agregar DiseÃ±o a la Nube</button>
    </div>`;
}

function bindMainEvents() {
    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => { activeTab = btn.dataset.tab; orderResults = null; render(); });
    });

    // History folder toggle
    document.querySelectorAll('.history-folder').forEach(folder => {
        folder.addEventListener('click', (e) => {
            const idx = folder.dataset.index;
            const content = document.getElementById(`history-content-${idx}`);
            const arrow = folder.querySelector('span:last-child');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = 'â–²';
            } else {
                content.style.display = 'none';
                arrow.textContent = 'â–¼';
            }
        });
    });

    // Client search in reports
    const clientSearchInput = document.getElementById('clientSearch');
    if (clientSearchInput) {
        let searchTimeout;
        clientSearchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const resultsDiv = document.getElementById('clientSearchResults');
                
                if (!searchTerm) {
                    resultsDiv.innerHTML = '';
                    return;
                }
                
                const matchingOrders = deliveryHistory.filter(h => 
                    (h.clientName || '').toLowerCase().includes(searchTerm)
                );
                
                if (matchingOrders.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding:16px;text-align:center;color:#6b7280;background:white;border-radius:8px;margin-top:12px">No se encontraron pedidos para este cliente</div>';
                    return;
                }
                
                resultsDiv.innerHTML = `
                    <div style="background:white;border-radius:8px;padding:16px;margin-top:12px;border:2px solid #5C7E8F">
                        <div style="font-weight:700;color:#5C7E8F;margin-bottom:12px;font-size:1rem">
                            âœ“ ${matchingOrders.length} pedido${matchingOrders.length > 1 ? 's' : ''} encontrado${matchingOrders.length > 1 ? 's' : ''}
                        </div>
                        <div style="display:flex;flex-direction:column;gap:12px;max-height:400px;overflow-y:auto">
                            ${matchingOrders.map(h => {
                                const date = new Date(h.timestamp);
                                const dateStr = date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
                                const timeStr = date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                                const totalItems = [...(h.available||[]), ...(h.outOfStock||[]), ...(h.notFound||[])].reduce((sum, item) => sum + item.qty, 0);
                                
                                return `
                                    <div style="padding:12px;background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb">
                                        <div style="font-weight:700;color:#2D3748;margin-bottom:4px">${h.clientName}</div>
                                        <div style="font-size:0.85rem;color:#6b7280;margin-bottom:8px">${dateStr} â€¢ ${timeStr} â€¢ ${totalItems} unidades</div>
                                        <div style="display:flex;flex-wrap:wrap;gap:6px">
                                            ${[...(h.available||[]), ...(h.outOfStock||[]), ...(h.notFound||[])].map(item => `
                                                <span style="background:white;padding:4px 10px;border-radius:6px;font-size:0.8rem;font-weight:600;color:#5C7E8F;border:1px solid #D4DDE2">
                                                    ${item.code} x${item.qty}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }, 200);
        });
    }

    // Search client buttons
    document.querySelectorAll('.search-client-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const clientName = btn.dataset.client;
            const searchInput = document.getElementById('clientSearch');
            if (searchInput) {
                searchInput.value = clientName;
                searchInput.dispatchEvent(new Event('input'));
                searchInput.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    // History search
    const historySearchInput = document.getElementById('historySearch');
    if (historySearchInput) {
        let searchTimeout;
        historySearchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const historyList = document.getElementById('historyList');
                
                if (!historyList) return;
                
                const filteredHistory = searchTerm ? deliveryHistory.filter(h => {
                    const clientMatch = (h.clientName || '').toLowerCase().includes(searchTerm);
                    const dateMatch = new Date(h.timestamp).toLocaleDateString('es-MX').includes(searchTerm);
                    const codesMatch = [...(h.available||[]), ...(h.outOfStock||[]), ...(h.notFound||[])].some(item => 
                        item.code.toLowerCase().includes(searchTerm)
                    );
                    return clientMatch || dateMatch || codesMatch;
                }) : deliveryHistory;
                
                if (filteredHistory.length === 0) {
                    historyList.innerHTML = '<div style="text-align:center;padding:48px;color:#A2A2A2">No se encontraron resultados</div>';
                } else {
                    historyList.innerHTML = filteredHistory.map((h, idx) => {
                        const date = new Date(h.timestamp);
                        const dateStr = date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
                        const timeStr = date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                        
                        return `
                        <div style="border:2px solid #D4DDE2;border-radius:12px;overflow:hidden;background:white">
                            <div class="history-folder" data-index="${idx}" style="padding:16px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:#f9fafb;transition:background 0.2s">
                                <div style="flex:1">
                                    <div style="font-weight:700;font-size:1.1rem;color:#5C7E8F;margin-bottom:4px">ğŸ“ ${h.clientName || 'Sin nombre'}</div>
                                    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                                        <span style="font-size:0.85rem;color:#6b7280">${dateStr} â€¢ ${timeStr}</span>
                                        <span style="background:#5C7E8F;color:white;padding:2px 10px;border-radius:20px;font-size:0.75rem;font-weight:600">${h.totalCodes} cÃ³digos</span>
                                    </div>
                                </div>
                                <span style="font-size:1.5rem;color:#5C7E8F">â–¼</span>
                            </div>
                            <div id="history-content-${idx}" style="display:none;padding:16px;border-top:1px solid #e5e7eb;max-height:4000px;overflow-y:scroll;overflow-x:hidden;-webkit-overflow-scrolling:touch">
                                ${renderHistoryContent(h)}
                            </div>
                        </div>
                        `;
                    }).join('');
                    
                    // Re-attach folder toggle listeners
                    document.querySelectorAll('.history-folder').forEach(folder => {
                        folder.addEventListener('click', (e) => {
                            const idx = folder.dataset.index;
                            const content = document.getElementById(`history-content-${idx}`);
                            const arrow = folder.querySelector('span:last-child');
                            if (content.style.display === 'none') {
                                content.style.display = 'block';
                                arrow.textContent = 'â–²';
                            } else {
                                content.style.display = 'none';
                                arrow.textContent = 'â–¼';
                            }
                        });
                    });
                }
            }, 200);
        });
    }

    // Header buttons
    document.getElementById('btnDarkMode')?.addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        localStorage.setItem('dtf_darkMode', isDarkMode);
        render();
    });
    document.getElementById('btnExport')?.addEventListener('click', exportData);
    document.getElementById('btnImport')?.addEventListener('click', importData);
    document.getElementById('btnLogout')?.addEventListener('click', async () => {
        if (confirm('Â¿Cerrar sesiÃ³n?')) { if (unsubscribe) unsubscribe(); await signOut(auth); }
    });

    // Image modal
    document.getElementById('imgModal')?.addEventListener('click', () => { imageModal = null; render(); });
    document.querySelectorAll('.view-img').forEach(img => {
        img.addEventListener('click', () => { imageModal = img.dataset.url; render(); });
    });

    // Order tab
    document.getElementById('btnOCR')?.addEventListener('click', handleOCR);
    document.getElementById('btnContinuousScan')?.addEventListener('click', handleContinuousScan);
    document.getElementById('btnProcess')?.addEventListener('click', processOrder);
    document.getElementById('btnCompleteOrder')?.addEventListener('click', completeOrder);
    document.querySelectorAll('.deliver-btn').forEach(btn => {
        btn.addEventListener('click', () => deliverOrder(btn.dataset.code, parseInt(btn.dataset.qty)));
    });
    document.querySelectorAll('.print-btn').forEach(btn => {
        btn.addEventListener('click', () => markPrinted(btn.dataset.code));
    });

    // Inventory tab
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchTerm = e.target.value;
                render();
            }, 150);
        });
    }
    document.querySelectorAll('.add-img-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const code = btn.dataset.code;
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0]; if (!file) return;
                setLoading(true, `Comprimiendo y guardando imagen de ${code}...`);
                const result = await uploadImageCloud(file, code);
                if (result.success) {
                    const d = designs.find(x => x.code === code);
                    if (d) { 
                        d.imageUrl = result.url; 
                        await saveDesignCloud(d);
                        alert(`âœ… Imagen de ${code} guardada!`);
                    }
                }
                setLoading(false);
            };
            input.click();
        });
    });
    document.querySelectorAll('.add-stock-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const code = btn.dataset.code;
            const qty = prompt(`Agregar stock a ${code}:`, '10');
            if (!qty) return;
            const d = designs.find(x => x.code === code);
            if (d) { d.stock = (d.stock||0) + parseInt(qty); d.isPrinted = true; d.lastPrinted = new Date().toISOString(); await saveDesignCloud(d); }
        });
    });
    document.querySelectorAll('.adj-stock-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const code = btn.dataset.code;
            const qty = prompt(`Stock actual: ${btn.dataset.stock}. Nuevo stock:`, btn.dataset.stock);
            if (qty === null) return;
            const d = designs.find(x => x.code === code);
            if (d) { 
                d.stock = Math.max(0, parseInt(qty)||0);
                // Si el stock llega a 0, marcar como pendiente
                if (d.stock === 0) {
                    d.isPrinted = false;
                }
                await saveDesignCloud(d);
            }
        });
    });
    document.querySelectorAll('.del-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            if (confirm(`Â¿Eliminar ${btn.dataset.code}?`)) await deleteDesignCloud(btn.dataset.code);
        });
    });

    // Bulk import
    document.getElementById('btnBulkImport')?.addEventListener('click', bulkImport);

    // New design
    document.getElementById('btnSaveNew')?.addEventListener('click', async () => {
        const code = document.getElementById('newCode')?.value?.trim().toUpperCase();
        if (!code) { alert('El cÃ³digo es obligatorio'); return; }
        setLoading(true, 'Guardando diseÃ±o en la nube...');
        await saveDesignCloud({
            code,
            client: document.getElementById('newClient')?.value || '',
            description: document.getElementById('newDesc')?.value || '',
            notes: document.getElementById('newNotes')?.value || '',
            stock: parseInt(document.getElementById('newStock')?.value) || 0,
            isPrinted: document.getElementById('newPrinted')?.checked || false,
            imageUrl: null,
            createdAt: new Date().toISOString()
        });
        setLoading(false);
        alert(`âœ… DiseÃ±o ${code} guardado en la nube!`);
        activeTab = 'inventario';
        render();
    });
}

// â”€â”€ AUTH LISTENER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
        loadingMessage = 'Cargando inventario desde la nube...';
        isLoading = true;
        isDarkMode = localStorage.getItem('dtf_darkMode') === 'true';
        document.body.classList.toggle('dark-mode', isDarkMode);
        render();
        setupListener(user.uid);
        loadDeliveryHistory();
    } else {
        isLoading = false;
        designs = [];
        deliveryHistory = [];
        render();
    }
});

render();
</script>
</body>
</html>
